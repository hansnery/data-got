//------------------------------------------------------------------------------
// This is the magic thing in the .bse file that tells how to center the base layout compared to the game position of the fortress
Object GuldurFortressCenterGeneric

	SelectPortrait = BPGuldurFortress

	Draw = W3DScriptedModelDraw ModuleTag_01

    	DefaultModelConditionState
      		Model = None
    	End

		ModelConditionState = WORLD_BUILDER
			Model = NBasePin
		End
	End

	Side			= Guldur
	EditorSorting	= STRUCTURE
	KindOf			= IMMOBILE BASE_FOUNDATION CASTLE_CENTER

	Behavior = CastleBehavior ModuleTag_castle
		//Anything that does not fit this filter will be given to the neutral player, so the template can have rocks and props.
		FilterValidOwnedEntries = ANY +STRUCTURE +WALK_ON_TOP_OF_WALL +BASE_FOUNDATION +TACTICAL_MARKER
	End
End

//------------------------------------------------------------------------------
// These are the four corner buildplots.  Difference is just the BuildVariation flag they give the Expansion.
Object GuldurFortressExpansionPadCorner

	SelectPortrait = BPGuldurPlot

	// *** ART Parameters ***

	Draw = W3DFloorDraw DrawFloorBase
		ModelName = UBFoundation
	End

	// *** ART Parameters ***
	Draw = W3DScriptedModelDraw ModuleTag_DrawMain
		DefaultModelConditionState
			Model = UBFoundationP
		End
		//Remove the buildplot when it's been constructed on
		ModelConditionState = CONSTRUCTION_COMPLETE
			Model = None
		End
	End

	// ***DESIGN parameters ***
	DisplayName         = OBJECT:WildBuildingFoundation
	Side                = Guldur
	EditorSorting       = STRUCTURE
	ThreatLevel			= 1.0

	BuildCost           = 1
	BuildTime           = 5.0          // in seconds
	VisionRange         = 0.0          // Shroud clearing distance
	ShroudClearingRange = 0

	CommandSet = WildFortressExpansionPadCornerCommandSet

	// *** AUDIO Parameters ***

	VoiceSelect = Gui_PlotSelect2

	// *** ENGINEERING Parameters ***
	KindOf              = STRUCTURE SELECTABLE IMMOBILE BASE_FOUNDATION UNATTACKABLE MP_COUNT_FOR_VICTORY NO_COLLIDE DO_NOT_CLASSIFY EXPANSION_PAD

	Behavior		= FoundationAIUpdate ModuleTag_foundationAI
		BuildVariation	= 2 // Will give BUILD_VARIATION_TWO to anything built on it
	End

	Behavior = CastleMemberBehavior ModuleTag_CMB
	End

	Body                = ImmortalBody ModuleTag_05
		MaxHealth         = 15000.0
	End

	Geometry				= BOX
	GeometryMajorRadius		= 5.0
	GeometryMinorRadius		= 5.0
	GeometryHeight			= 0.8
	GeometryIsSmall			= No
	Shadow					= SHADOW_VOLUME
	BuildCompletion			= PLACED_BY_PLAYER
End

//--------------------------
// And these are the plots on the sides.
ChildObject GuldurFortressExpansionPadSide GuldurFortressExpansionPadCorner

	CommandSet = GuldurFortressExpansionPadSideCommandSet

	Behavior            = FoundationAIUpdate ModuleTag_foundationAI
		BuildVariation = 1 ;// Will give BUILD_VARIATION_ONE to anything built on it
	End
End

//--------------------------
// And these are the plots on the sides.
ChildObject GuldurExpansionPlot_DolGuldur GuldurFortressExpansionPadCorner
	Draw = W3DFloorDraw DrawFloorBase
		ModelName = UBFoundatiot
	End
	CommandSet = GuldurExpansionPadCommandSet_DG
	Behavior            = FoundationAIUpdate ModuleTag_foundationAI
		BuildVariation = 1 ;// Will give BUILD_VARIATION_ONE to anything built on it
	End
End

//------------------------------------------------------------------------------
//Guldur Fortress Citadel
// This is the center part of the full Fortress.  This plus the buildplots make up the full fortress
Object GuldurFortressCitadel

	SelectPortrait	= BPGuldurFortress
	ButtonImage		= BIGuldurFortress

	Draw = W3DScriptedModelDraw ModuleTag_Draw
		ExtraPublicBone 		= ARROW01
		ExtraPublicBone 		= ARROW02
		ExtraPublicBone 		= ARROW03
		ExtraPublicBone 		= ARROW04
		ExtraPublicBone 		= ARROW05
		ExtraPublicBone 		= ARROW06
		ExtraPublicBone 		= ARROW07
		ExtraPublicBone 		= ARROW08
		OkToChangeModelColor	= Yes
		UseStandardModelNames	= Yes
		StaticModelLODMode		= Yes // Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model				= ubfort_skn
			WeaponLaunchBone	= PRIMARY ARROW
		End

		;//	Animation state for build placement cursor
		AnimationState = BUILD_PLACEMENT_CURSOR
			BeginScript
   				CurDrawableHideSubObject("SORCERY")
   				CurDrawableHideSubObject("ENCROACH")
   				CurDrawableHideSubObject("PALANTIR")
   				CurDrawableHideSubObject("TORCHES")
			EndScript
		End

		;//	Animation state for phantom structure
		AnimationState = PHANTOM_STRUCTURE
			BeginScript
   				CurDrawableHideSubObject("SORCERY")
   				CurDrawableHideSubObject("ENCROACH")
   				CurDrawableHideSubObject("PALANTIR")
   				CurDrawableHideSubObject("TORCHES")
			EndScript
		End

		IdleAnimationState
		End

		AnimationState			= FORTRESS_IMPROVEMENT_2
			ParticleSysBone   	= PALEFX01 GuldurPaleFireNoSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX01 CampFireSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX02 GuldurPaleFireNoSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX02 CampFireSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX03 GuldurPaleFireNoSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX03 CampFireSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX04 GuldurPaleFireNoSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX04 CampFireSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX05 GuldurPaleFireNoSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX05 CampFireSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX06 GuldurPaleFireNoSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX06 CampFireSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX07 GuldurPaleFireNoSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX07 CampFireSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX08 GuldurPaleFireNoSmoke FollowBone:Yes
			ParticleSysBone   	= PALEFX08 CampFireSmoke FollowBone:Yes
		End

        //--Damage States---
		ModelConditionState  = DAMAGED
			Model		= ubfort_d1
			;Texture		= WBFortress.tga WBFortress_D.tga
			;Texture		= wbgunfortress2.tga wbgunfortress2_d.tga
		End

		AnimationState = DAMAGED
			EnteringStateFX	= FX_FortressDamaged
		End

		ModelConditionState  = REALLYDAMAGED
			Model			= ubfort_d2
		End

		AnimationState	= REALLYDAMAGED
			EnteringStateFX	= FX_FortressReallyDamaged
		End

		ModelConditionState  = RUBBLE
			Model			= ubfort_d2
		End

		AnimationState	= RUBBLE
			EnteringStateFX	= FX_StructureMediumCollapse
		End

    	ModelConditionState  = POST_RUBBLE
    		Model         = None
			ParticleSysBone NONE SmokeBuildingMediumRubble
    	End

		AnimationState = POST_RUBBLE
    	End

		ModelConditionState  = POST_COLLAPSE
			Model         = None
			ParticleSysBone NONE SmokeBuildingMediumRubble
		End

		AnimationState = POST_COLLAPSE
		End

;		ModelConditionState = UPGRADE_NUMENOR_STONEWORK
;			Model	= wbgobfort_skn
;			;Texture	= WBFortress.tga WBFortress_U.tga
;			;Texture	= wbgunfortress2.tga wbgunfortress2_u.tga
;		End

		ModelConditionState = SNOW
			Model			= ubfort_skn
			Texture			= ubruin1.tga ubruin1_snow.tga
		End
	End

;	Draw = W3DScriptedModelDraw ModuleTag_Draw_HCBanner
;		OkToChangeModelColor  = Yes
;		DefaultModelConditionState
;			Model = WBHCFortress
;		End
;		MultiPlayerOnly = Yes
;	End

	;//Bat Cloud
	Draw = W3DScriptedModelDraw ModuleTag_DrawBatCloud

		StaticModelLODMode		= Yes // Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		ModelConditionState = FORTRESS_IMPROVEMENT_1
			Model		= Bats_SKN
		End

		AnimationState	= FORTRESS_IMPROVEMENT_1
			Animation	= WBFBCloud
				AnimationName	= Bats_SKL.Bats_IDLB
				AnimationMode	= LOOP
			End
			Flags				= START_FRAME_FIRST
		End
	End

	Draw = W3DFloorDraw ModuleTag_DrawFloor
		;//StaticModelLODMode = Yes		;// THIS NEEDS TO BE COMMENTED OUT WHEN ENGINEERING ENABLES LOD'S IN THE FLOOR DRAW
		ModelName			= ubfort_bib
		WeatherTexture		= SNOWY ubfort_bib_snow.tga
	End

	//Blight Mist
	Draw = W3DScriptedModelDraw ModuleTag_DrawMist

		DefaultModelConditionState
			Model				= None
		End

		ModelConditionState   = FORTRESS_IMPROVEMENT_8
			Model				= None
			ParticleSysBone		= NONE GuldurFortressMist
			ParticleSysBone		= NONE GuldurFortressBlightSwampCloud
			ParticleSysBone		= NONE GuldurFortressBlightSwampCloud02
			ParticleSysBone		= NONE GuldurFortressBlightFlies
		End
	End

  	;// ***DESIGN parameters ***
  	DisplayName         	= OBJECT:WildFortress
  	Description 	      	= OBJECT:WildFortressDescription

  	Side                	= Guldur
  	EditorSorting       	= STRUCTURE
  	ThreatLevel				= 1.0
 	CommandPointBonus		= GENERIC_FORTRESS_COMMAND_POINT_BONUS

	MaxSimultaneousOfType = 5 ;;,;; Added for 2.02e (T.C.)
  	CommandSet          	= GuldurFortressCommandSet

	Behavior = CommandSetUpgrade ModueTag_WOTRCommandSet
		TriggeredBy			= Upgrade_WOTRMode
		;ConflictsWith		=
		CommandSet			= GuldurFortressCommandSet_WOTR
	End

  	BuildCost           	= 5000 ;WILD_FORTRESS_BUILDCOST
  	BuildTime           	= 120
  	BountyValue         	= WILD_FORTRESS_BOUNTY_VALUE
  	VisionRange         	= WILD_FORTRESS_VISION_RANGE
  	ShroudClearingRange 	= WILD_FORTRESS_SHROUD_CLEAR

	WeaponSet
		Weapon				= PRIMARY GuldurFortressArrowTowerBow
		AutoChooseSources	= PRIMARY FROM_PLAYER FROM_SCRIPT FROM_AI
	End

	ArmorSet
		Conditions        = None
		Armor             = FortressArmor
		;DamageFX          = StructureDamageFXNoShake
	End

	;// *** AUDIO Parameters ***

	#include "..\..\..\Includes\StandardBuildingEvaEvents.inc"

	EvaEventDieOwner 				= EvaFortressDie
	EvaEventDieAlly                 = AllyCampDestroyed ;,; Added in v5.1
    EvaEventDieEnemy                = EnemyCampDestroyed ;,; Added in v5.1

	VoiceSelect						= GuldurFortressSelect  ;IsengardCitadelSelect
	VoiceSelectUnderConstruction	= BuildingEvilVoiceSelectUnderConstruction

	SoundOnDamaged					= BuildingLightDamageStone
	SoundOnReallyDamaged			= BuildingHeavyDamageStone

	UnitSpecificSounds
		UnderConstruction			= BuildingBigConstructionLoop	;// Built first time
		;//UnderRepairFromDamage	= NoSound						;// Repaired No animation on the building, so don't bother playing sound
		UnderRepairFromRubble		= BuildingBigConstructionLoop	;// Repaired from completely destroyed (not used???)
	End

	ClientBehavior = AnimationSoundClientBehavior ModuleTag_AnimAudioBehavior
		MaxUpdateRangeCap = 800
		AnimationSound = Sound:UpgradeMordorFortressGorgonothSpire	Animation:WBFGThrone_ASK.WBFGThrone_ABL		Frames:3950
	End

	CampnessValue = CAMPNESS_FORTRESS

	;// *** ENGINEERING Parameters ***
	RadarPriority       = STRUCTURE
	KindOf				= PRELOAD COMMANDCENTER VITAL_FOR_BASE_SURVIVAL STRUCTURE IMMOBILE CASTLE_KEEP MP_COUNT_FOR_VICTORY SELECTABLE FS_FACTORY AUTO_RALLYPOINT MADE_OF_WOOD SCORE DOZER_FACTORY

	Behavior            = GettingBuiltBehavior GetBuiltBehaviorTag
		WorkerName		  = GuldurFortressWorkerNoSelect
		SpawnTimer	= 110 ;DEFAULT_STRUCTURE_HEALDELAY
	End

	Behavior = CastleMemberBehavior ModuleTag_CMB
	End

	Body                        = StructureBody ModuleTag_05
		MaxHealth         		    = WILD_FORTRESS_HEALTH
		MaxHealthDamaged  		    = WILD_FORTRESS_HEALTH_DAMAGED
		MaxHealthReallyDamaged 	  	= WILD_FORTRESS_HEALTH_REALLY_DAMAGED

;//		DamageCreationList = OCL_BuildingDamageList01 CATAPULT_ROCK
;//		DamageCreationList = OCL_GBStable_Chunk1 CATAPULT_ROCK FRONT_DESTROYED
;//		DamageCreationList = OCL_GBStable_Chunk2 CATAPULT_ROCK RIGHT_DESTROYED
;//		DamageCreationList = OCL_GBStable_Chunk3 CATAPULT_ROCK BACK_DESTROYED
;//		DamageCreationList = OCL_GBStable_Chunk4 CATAPULT_ROCK LEFT_DESTROYED

	End

	;Behavior                  = BuildingBehavior BuildingModuleTag
	;NightWindowName	= WINSHINE25
	;// NightWindowName			= GBWORKSHOPN
	;// FireWindowName			= WINDOW_F01
	;// GlowWindowName			= WINDOW_G01
	;// FireName					= FIRE01
	;End

;//	Behavior = RefundDie ModuleTag_refund
;//		UpgradeRequired = Upgrade_MarketplaceUpgradeDefiance
;//		BuildingRequired = ANY +GondorMarketPlace
;//		RefundPercent = 50%
;//	End

	Behavior                  = StructureCollapseUpdate ModuleTag_06
		MinCollapseDelay        = 000
		MaxCollapseDelay        = 000
		CollapseDamping         = .5
		MaxShudder              = 0.6
		MinBurstDelay           = 250
		MaxBurstDelay           = 800
		BigBurstFrequency       = 4
		FXList                  = INITIAL   FX_FortressCollapse
		;FXList                  = ALMOST_FINAL  FX_FortressCollapse
		DestroyObjectWhenDone	= Yes
		CollapseHeight			= 120
	End

	Behavior = ProductionUpdate ProductionUpdateModuleTagNew
		//Porter cost bonus
		ProductionModifier		;// An object-local discount.
			RequiredUpgrade	= Upgrade_WildFortressGoblinTown
			CostMultiplier	= 0.80
			ModifierFilter	= NONE +WildPorter
		End
		//Hero cost/build time bonus
		ProductionModifier
			RequiredUpgrade = Upgrade_WildFortressGoblinTown
			CostMultiplier	= 0.90
			TimeMultiplier	= 0.90
			HeroPurchase	= Yes	// Instead of an object filter, needs to be explicitly hero-revival-system compatible
		End
	End

	;/////////////////////////////
	;/// AI FORTRESS MODIFIERS
	;///
	#include "..\..\..\Includes\AIFortressFunctions.inc"
	;///

	Behavior = ModelConditionUpgrade ModuleTag_BlightMist
		TriggeredBy				= Upgrade_GuldurFortressBlight
		AddConditionFlags		= FORTRESS_IMPROVEMENT_8
		Permanent				= Yes
	End

	Behavior = FireWeaponUpdate ModuleTag_DamageHandler
		FireWeaponNugget
			WeaponName	= GuldurFortressBlightWeapon
			Offset 		= X:0 Y:0 Z:0
			FireDelay	= 0
			OneShot		= No
		End
	End

	;Behavior = SpawnBehavior ModuleTag_SpawnBlightWeapon
	;	TriggeredBy			= Upgrade_GuldurFortressBlight
	;	SpawnNumber			= 1
	;	InitialBurst		= 1
	;	SpawnTemplateName	= GuldurFortressBlightCompromiseWeapon
	;	SpawnReplaceDelay	= 0
	;	CanReclaimOrphans	= Yes
	;End

	Behavior = CastleUpgrade ModuleTag_PassOutGoblinTownUpgrade
		TriggeredBy	= Upgrade_WildFortressGoblinTownTrigger
		Upgrade		= Upgrade_WildFortressGoblinTown
	End

	Behavior = ModelConditionUpgrade ModuleTag_GoblinTownModel
		TriggeredBy			= Upgrade_WildFortressGoblinTownTrigger
		AddConditionFlags	= USER_7
		Permanent			= Yes
	End

	Behavior = ModelConditionUpgrade ModuleTag_NorthernWastesModel
		TriggeredBy			= Upgrade_WildFortressNorthernWastes
		AddConditionFlags	= USER_8
		Permanent			= Yes
	End

	Behavior = ProductionUpdate ProductionUpdateModuleTag
	End

	Behavior = QueueProductionExitUpdate QueueProductionModuleTag
		UnitCreatePoint		= X:15.0 Y:0.0 Z:0.0
		NaturalRallyPoint	= X:100.0 Y:0.0 Z:0.0
		ExitDelay			= 50
	End

	;Behavior = CommandSetUpgrade ModuleTag_DwarvenGuardianHordeBladesCommandSet
	;	TriggeredBy		= Upgrade_WildFortressGoblinTownTrigger
	;	CommandSet		= WildFortressCommandSet_GoblinTown
	;End

	Behavior = AIUpdateInterface ModuleTag_AI
		AutoAcquireEnemiesWhenIdle	= Yes ATTACK_BUILDINGS
		AILuaEventsList				= GuldurFortressFunctions
		AutoAcquireEnemiesWhenIdle	= Yes
		MoodAttackCheckRate			= 250
	End

	;//////
	;// LATEGAME TRIGGER
	;//////

	Behavior = ObjectCreationUpgrade ModuleTag_AILateGameTriggerEnablerHard
		TriggeredBy = Upgrade_GuldurFaction Upgrade_HardAIMultiPlayer
		ThingToSpawn = LateGameUpgradeGranter
		RequiresAllTriggers = Yes
		Delay = 780000
	End

	Behavior = ObjectCreationUpgrade ModuleTag_AILateGameTriggerEnablerBrutal
		TriggeredBy = Upgrade_GuldurFaction Upgrade_BrutalAIMultiPlayer
		ThingToSpawn = LateGameUpgradeGranter
		RequiresAllTriggers = Yes
		Delay = 780000
	End

	;//////

    Behavior = SubObjectsUpgrade ModuleTag_HideAll
		TriggeredBy		= Upgrade_StructureLevel1
		HideSubObjects	= SORCERY ENCROACH PALANTIR TORCHES
	End

	;//Drums in the Deep

	Behavior = SubObjectsUpgrade ModuleTag_ShowDrums
		TriggeredBy		= Upgrade_WildFortressDrums
		ShowSubObjects	= DRUM
	End

	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_DrumsInTheDeep
		SpecialPowerTemplate	= SpecialAbilityDrumsInTheDeep
		TriggeredBy				= Upgrade_WildFortressDrums
	End

	Behavior = OCLSpecialPower ModuleTag_SummonDrumsInTheDeep
		SpecialPowerTemplate = SpecialAbilityDrumsInTheDeep
		OCL                  = OCL_SpawnDrumsInTheDeepEgg ; OCL_SpawnMordorShelob
		TriggerFX			 = FX_SummonWildmen
		CreateLocation       = CREATE_AT_LOCATION
		StartsPaused		  	  = Yes
		;TriggerSpecialPower				= ModuleTag_MightyRageDebuff	TARGETPOS
	End

	;//Summon the Wyrm

	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_WyrmSummon
		SpecialPowerTemplate	= SpecialAbilitySummonWyrm
		TriggeredBy				= Upgrade_WildFortressNorthernWastes
	End

	Behavior = OCLSpecialPower ModuleTag_SummonTheWyrm
		SpecialPowerTemplate = SpecialAbilitySummonWyrm
		OCL                  = OCL_SpawnWyrmEgg
		TriggerFX			 = FX_SummonWildmen
		CreateLocation       = CREATE_AT_LOCATION
		StartsPaused		  	  = Yes
		;TriggerSpecialPower				= ModuleTag_MightyRageDebuff	TARGETPOS
	End

	Behavior = SpecialPowerModule ModuleTag_MightyRageDebuff
		SpecialPowerTemplate			= SpecialAbilityActivateeDummy
		AttributeModifier				= DainRageDeBuff
		AttributeModifierRange			= DAIN_MIGHTYRAGE_EFFECT_RADIUS
		AttributeModifierAffects		= AOTR_GENERIC_BUFF_RECIPIENT_OBJECT_FILTER
		AntiCategory					= LEADERSHIP ;;,;; removed BUFF
	End

	;//Bat Cloud
	Behavior = ModelConditionUpgrade ModuleTag_ShowTheBatCloud
		TriggeredBy				= Upgrade_GuldurFortressBatCloud
		RequiresAllTriggers		= Yes
		AddConditionFlags		= FORTRESS_IMPROVEMENT_1
		Permanent				= Yes
	End

	Behavior = AttributeModifierUpgrade ModuleTag_BatCloudBonus
		AttributeModifier	= WildFortressBatCloudBonus		;//Vision bonus
		TriggeredBy			= Upgrade_GuldurFortressBatCloud
	End

	Behavior = StealthDetectorUpdate StealthDetectorUpdateModuleTag
		DetectionRange		= 800	;// range to detect
		DetectionRate		= 500   ;// how often to rescan for stealthed things in my sight (msec)
		CancelOneRingEffect = Yes	;// forces uses of one-ring to pop out of it
		RequiredUpgrade		= Upgrade_GuldurFortressBatCloud ;//Won't work until this upgrade is purchased
	End
	;//End Bat Cloud Behaviors

	;//Fire Arrows improvement
	Behavior = CastleUpgrade ModuleTag_PassOutFlamingMunitionsUpgrade
		TriggeredBy	= Upgrade_GuldurFortressFireArrowsTrigger
		Upgrade		= Upgrade_EvilFortressFlamingMunitions
	End

	Behavior = AttributeModifierAuraUpdate ModuleTag_SummonedStructureFlamingMunitions
		StartsActive			= No ;If no, requires upgrade to turn on.
		BonusName			= SummonedStructureFlamingMunitionsEvil
		TriggeredBy			= Upgrade_GuldurFortressFireArrowsTrigger ;DragonnestUpgradePassout
		RefreshDelay			= 2000
		Range				= 200 ;MORDOR_FORTRESS_WALL_EFFECTIVE_RADIUS ;;,;; 99999
		ObjectFilter			= ANY +GuldurBarricadeExpansion -GuldurFortress -GuldurFortressCitadel
	End

	Behavior = StatusBitsUpgrade ModuleTag_FakeOut ;// I need to react to the upgrade, so I can have it for when new construction asks me for all the upgrades
		TriggeredBy	= Upgrade_EvilFortressFlamingMunitions
	End

	Behavior = SubObjectsUpgrade ModuleTag_ShowTorches
		TriggeredBy		= Upgrade_EvilFortressFlamingMunitions
		ShowSubObjects	= TORCHES
	End

	Behavior = ModelConditionUpgrade ModuleTag_ShowTorches2
		TriggeredBy				= Upgrade_EvilFortressFlamingMunitions
		AddConditionFlags		= FORTRESS_IMPROVEMENT_2
		Permanent				= Yes
	End

//--------------------------------------------------------------------------
//	DARK ENCROACHMENT
//--------------------------------------------------------------------------
    Behavior = SubObjectsUpgrade ModuleTag_DarkEncroachmentSubObj
		TriggeredBy		= Upgrade_GuldurFortressEncroachment
		ShowSubObjects	= ENCROACH
	End

	Behavior = AttributeModifierAuraUpdate ModuleTag_DarkEncroachment
		StartsActive	= No ;If no, requires upgrade to turn on.
		TriggeredBy		= Upgrade_GuldurFortressEncroachment
		ConflictsWith = Upgrade_ObjectUnderAIControl
		BonusName		= GuldurFortressEncroachment
		RefreshDelay	= 2000
		Range			= 9999999999
		ObjectFilter	= NONE +GuldurPorter +GuldurMillPorterAI +UniversalBuildingFoundation SAME_PLAYER
		AffectGood = No
		AffectEvil = No
	End

	Behavior = ObjectCreationUpgrade ModuleTag_DarkEncroachmentForAI
		TriggeredBy		= Upgrade_GuldurFortressEncroachment Upgrade_ObjectUnderAIControl
		RequiresAllTriggers = Yes
		Delay			= 0.0
		DestroyWhenSold = Yes
		ThingToSpawn	= DarkEncroachmentAI
	;	Offset			= X:-25.8 Y:-4.9 Z:37.2
		FadeInTime		= 100
	End

	Behavior = ObjectCreationUpgrade ModuleTag_MoreDarkEncroachmentForAI
		TriggeredBy		= Upgrade_GuldurFortressEncroachment Upgrade_ObjectUnderAIControl
		RequiresAllTriggers = Yes
		Delay			= 0.0
		DestroyWhenSold = Yes
		ThingToSpawn	= DarkEncroachmentAI
	;	Offset			= X:-25.8 Y:-4.9 Z:37.2
		FadeInTime		= 100
	End
//--------------------------------------------------------------------------
//	PALANTIR
//--------------------------------------------------------------------------
    Behavior = SubObjectsUpgrade ModuleTag_PalantirSubObject
		TriggeredBy		= Upgrade_GuldurFortressPalantir
		ShowSubObjects	= PALANTIR
	End
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_FarsightUnpause
		SpecialPowerTemplate	= SpecialAbilityGuldurPalantir
		TriggeredBy				= Upgrade_GuldurFortressPalantir
	End
	Behavior = OCLSpecialPower ModuleTag_FarsightOCL
		StartsPaused			= Yes
		SpecialPowerTemplate	= SpecialAbilityGuldurPalantir
		OCL						= OCL_SpecialPowerGuldurPalantir
		CreateLocation			= CREATE_AT_LOCATION
	End
	Behavior = AutoAbilityBehavior ModuleTag_ElrondFarsightAutoAbility ;;,;;
		SpecialAbility			= SpecialAbilityGuldurPalantir
		ForbiddenStatus = INSIDE_GARRISON ;;,;; This seems to prevent the ability from being used inside a tower
    End
//--------------------------------------------------------------------------
//	SORCERY
//--------------------------------------------------------------------------
	;---------------------Fortress Armor Upgrade-------------------------
    Behavior = SubObjectsUpgrade ModuleTag_SorcerySubObject
		TriggeredBy		= Upgrade_GuldurFortressSorcery
		ShowSubObjects	= SORCERY
	End
   Behavior = AttributeModifierUpgrade ModuleTag_Reinforced
		TriggeredBy				= Upgrade_GuldurFortressSorcery
		AttributeModifier		= NumenorStoneworkKeep_Bonus
	End
	;---------------------------------------------------------------------
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_DominateCasterEnabler
		SpecialPowerTemplate		= SpecialAbilityGuldurFortressEnsnareCaster
		TriggeredBy					= Upgrade_GuldurFortressSorcery
	End
	Behavior = SpecialPowerModule ModuleTag_DominateEnemyCaster
		SpecialPowerTemplate		= SpecialAbilityGuldurFortressEnsnareCaster
		StartsPaused				= Yes
		UpdateModuleStartsAttack	= Yes
		;InitiateSound				= SarumanVoiceDominate
	End
	Behavior = ActivateModuleSpecialPower ModuleTag_CloseTheGap
		SpecialPowerTemplate		= SpecialAbilityGuldurFortressEnsnareCaster
		StartAbilityRange		= 600
		TriggerSpecialPower		= ModuleTag_HillOfSorcery TARGETPOS
		TriggerSpecialPower		= ModuleTag_DominateEnemySpecialPowerModule TARGETPOS
	;	TriggerSpecialPower		= ModuleTag_NecroFellStrengthBuffStarter TARGETPOS
	End
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_HillOfSorceryEnabler
		SpecialPowerTemplate	= SpecialAbilityGuldurFortressEnsnareWeapon
		TriggeredBy				= Upgrade_GuldurFortressSorcery
	End
	Behavior = OCLSpecialPower ModuleTag_HillOfSorcery
		;SpecialPowerTemplate = SpecialAbilityGuldurHillOfSorcery
		SpecialPowerTemplate = SpecialAbilityGuldurFortressEnsnareWeapon
		OCL                  = OCL_GuldurFortressEnsnare
		;TriggerFX			 = FX_CrackOfDoom
		StartsPaused		 = Yes
		CreateLocation       = CREATE_AT_LOCATION
		;NearestSecondaryObjectFilter = NONE SAME_PLAYER +CASTLE_KEEP
	End
 	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_DominateEnabler
		SpecialPowerTemplate		= SpecialAbilityGuldurFortressEnsnare
		TriggeredBy					= Upgrade_GuldurFortressSorcery
	End
	Behavior = SpecialPowerModule ModuleTag_DominateEnemySpecialPowerModule
		SpecialPowerTemplate		= SpecialAbilityGuldurFortressEnsnare
		StartsPaused				= Yes
		UpdateModuleStartsAttack	= No
		;InitiateSound				= SarumanVoiceDominate
	End
 	Behavior = DominateEnemySpecialPower ModuleTag_DominateEnemySpecialPower
        SpecialPowerTemplate		= SpecialAbilityGuldurFortressEnsnare
		;UnpackingVariation			= 1
		StartAbilityRange			= 800
;;,;;		AttributeModifierAffects	= ALL -DOZER -HERO -STRUCTURE -ARMY_OF_DEAD -MOVE_ONLY -AngmarThrallMaster ENEMIES NEUTRAL
		AttributeModifierAffects	= AOTR_DOL_GULDUR_ENSNARE_OBJECTFILTER
		DominateRadius				= 100
		DominatedFX					= FX_GuldurDominateTargets
		TriggerFX					= FX_GuldurDominateTrigger   ;FX_SarumanDominateTrigger
		UnpackTime					= 100 ;;,;; 2000
		;PreparationTime				= 1
		FreezeAfterTriggerDuration	= 0
		;TriggerAttributeModifier	= GuldurEnsnare
	;	PermanentlyConvert			= No
    End
;====================================
;		Fell Storm
;====================================
	Behavior = UnpauseSpecialPowerUpgrade ModuleTag_RingOfAirEnabler
		SpecialPowerTemplate	= SpecialAbilitySilverHostSummonDummy
		TriggeredBy				= Upgrade_GuldurFortressSorcery
	End
	Behavior = SpecialPowerModule ModuleTag_CreateAHeroAthelas
		SpecialPowerTemplate	 = SpecialAbilitySilverHostSummonDummy
		UpdateModuleStartsAttack = Yes
		StartsPaused			 = Yes
	End

	Behavior = ActivateModuleSpecialPower ModuleTag_CreateAHeroAthelasUpdate
		SpecialPowerTemplate = SpecialAbilitySilverHostSummonDummy
		StartAbilityRange	 = 200
		TriggerSpecialPower = ModuleTag_StrengthRemembered_OCL
	End

	Behavior = OCLSpecialPower ModuleTag_StrengthRemembered_OCL
		SpecialPowerTemplate = ElrondRingOfAir2
		OCL                  = OCL_GuldurFortressFellStorm
		CreateLocation       = USE_OWNER_OBJECT
		StartsPaused		 = Yes
		TriggerFX			 = FX_AngmarFortressFellStormStart
	End

	;	--------------- AI ENSNARE ----------------;
		Behavior = UnpauseSpecialPowerUpgrade ModuleTag_DominateCasterEnabler_AI
			SpecialPowerTemplate		= SpecialAbilityGuldurFortressEnsnareCaster_AI
			TriggeredBy					= Upgrade_GuldurFortressSorcery Upgrade_ObjectUnderAIControl
			RequiresAllTriggers = Yes
		End
		Behavior = SpecialPowerModule ModuleTag_DominateEnemyCaster_AI
			SpecialPowerTemplate		= SpecialAbilityGuldurFortressEnsnareCaster_AI
			StartsPaused				= Yes
			UpdateModuleStartsAttack	= Yes
			;InitiateSound				= SarumanVoiceDominate
		End
		Behavior = ActivateModuleSpecialPower ModuleTag_CloseTheGap_AI
			SpecialPowerTemplate		= SpecialAbilityGuldurFortressEnsnareCaster_AI
			StartAbilityRange		= 600
		;	TriggerSpecialPower		= ModuleTag_HillOfSorcery TARGETPOS
			TriggerSpecialPower		= ModuleTag_DominateEnemySpecialPowerModule TARGETPOS
		;	TriggerSpecialPower		= ModuleTag_NecroFellStrengthBuffStarter TARGETPOS
		End
		Behavior = AutoAbilityBehavior ModuleTag_GimmeDat
			SpecialAbility = SpecialAbilityGuldurFortressEnsnareCaster_AI
		;	ForbiddenStatus = INSIDE_GARRISON
		;	Query = 1 ANY +MONSTER +SIEGEENGINE -MordorFellBeast -MordorFellBeastInterface -GondorGwaihir -GondorGwaihir_Summoned -ElvenFortressEagle -Drogoth ENEMIES
			Query = 10 ANY +INFANTRY +CAVALRY +MONSTER +SIEGEENGINE -MordorFellBeast -MordorFellBeastInterface -GondorGwaihir -ElvenGwaihir_Summoned -GondorGwaihir_Summoned -ElvenFortressEagle -Drogoth ENEMIES
			MaxScanRange = 800
			StartsActive = Yes
		End
		Behavior = UnpauseSpecialPowerUpgrade ModuleTag_HillOfSorceryEnabler_AI
			SpecialPowerTemplate	= SpecialAbilityGuldurFortressEnsnareWeapon_AI
			TriggeredBy				= Upgrade_GuldurFortressSorcery
		End
		Behavior = OCLSpecialPower ModuleTag_HillOfSorcery_AI
			;SpecialPowerTemplate = SpecialAbilityGuldurHillOfSorcery
			SpecialPowerTemplate = SpecialAbilityGuldurFortressEnsnareWeapon_AI
			OCL                  = OCL_GuldurFortressEnsnare
			;TriggerFX			 = FX_CrackOfDoom
			StartsPaused		 = Yes
			CreateLocation       = CREATE_AT_LOCATION
			;NearestSecondaryObjectFilter = NONE SAME_PLAYER +CASTLE_KEEP
		End
		Behavior = UnpauseSpecialPowerUpgrade ModuleTag_DominateEnabler_AI
			SpecialPowerTemplate		= SpecialAbilityGuldurFortressEnsnare_AI
			TriggeredBy					= Upgrade_GuldurFortressSorcery
		End
		Behavior = SpecialPowerModule ModuleTag_DominateEnemySpecialPowerModule_AI
			SpecialPowerTemplate		= SpecialAbilityGuldurFortressEnsnare_AI
			StartsPaused				= Yes
			UpdateModuleStartsAttack	= No
			;InitiateSound				= SarumanVoiceDominate
		End
		Behavior = DominateEnemySpecialPower ModuleTag_DominateEnemySpecialPower_AI
					SpecialPowerTemplate		= SpecialAbilityGuldurFortressEnsnare_AI
			;UnpackingVariation			= 1
			StartAbilityRange			= 800
	;;,;;		AttributeModifierAffects	= ALL -DOZER -HERO -STRUCTURE -ARMY_OF_DEAD -MOVE_ONLY -AngmarThrallMaster ENEMIES NEUTRAL
			AttributeModifierAffects	= AOTR_DOL_GULDUR_ENSNARE_OBJECTFILTER
			DominateRadius				= 100
			DominatedFX					= FX_GuldurDominateTargets
			TriggerFX					= FX_GuldurDominateTrigger   ;FX_SarumanDominateTrigger
			UnpackTime					= 100 ;;,;; 2000
			;PreparationTime				= 1
			FreezeAfterTriggerDuration	= 0
			;TriggerAttributeModifier	= GuldurEnsnare
		;	PermanentlyConvert			= No
			End
		;---------------------------------------------------;
		#include "..\..\..\aicoding\airetreatbeacons.inc"
//--------------------------------------------------------------------------
//	DARK PRESENCE MECHANIC
//--------------------------------------------------------------------------
	Behavior = GrantUpgradeCreate ModuleTag_GrantUpgrade
		UpgradeToGrant	= Upgrade_GondorStableLevel2
	End
	Behavior = AttributeModifierAuraUpdate ModuleTag_DarkPresence
		StartsActive	= No ;If no, requires upgrade to turn on.
		TriggeredBy		= Upgrade_GondorStableLevel2
		BonusName		= GuldurDarkPresence
		RefreshDelay	= 100
		Range			= 350
		ObjectFilter	= ANY +OathswornWarrior +OathswornBanner +OathswornWarriorHorde +AngmarSnaga +AngmarSnagaHorde +GuldurOrcRavagerBanner +GuldurTombGuardHorde +GuldurTombGuard +GuldurOrcRavager +GuldurOrcRavagerHorde +GuldurBrokenRabble +GuldurBrokenRabbleA +GuldurBrokenRabbleB +GuldurBrokenRabbleC +GuldurBrokenRabbleHorde +GuldurOrcArcher +GuldurOrcArcherHorde +GuldurOrcPikeman +GuldurOrcPikemanForBrokenRabble +GuldurOrcPikemanHorde +GuldurOrcArcherHorde_Summoned +GuldurOrcPikemanHorde_Summoned +GuldurBannerOrc +GuldurPikemenArcherComboHorde
	End
	Behavior = AttributeModifierAuraUpdate ModuleTag_DarkPresenceBuff
		StartsActive	= No ;If no, requires upgrade to turn on.
		TriggeredBy		= Upgrade_GondorStableLevel2
		BonusName		= GuldurDarkPresenceBuff
		RefreshDelay	= 2000
		Range			= 350
		ObjectFilter	= ANY +OathswornWarrior +OathswornBanner +OathswornWarriorHorde +AngmarSnaga +AngmarSnagaHorde +GuldurOrcRavagerBanner +GuldurTombGuardHorde +GuldurTombGuard +GuldurOrcRavager +GuldurOrcRavagerHorde +GuldurBrokenRabble +GuldurBrokenRabbleA +GuldurBrokenRabbleB +GuldurBrokenRabbleC +GuldurBrokenRabbleHorde +GuldurOrcArcher +GuldurOrcArcherHorde +GuldurOrcPikeman +GuldurOrcPikemanForBrokenRabble +GuldurOrcPikemanHorde +GuldurOrcArcherHorde_Summoned +GuldurOrcPikemanHorde_Summoned +GuldurBannerOrc +GuldurPikemenArcherComboHorde
	End
	Behavior = PassiveAreaEffectBehavior ModuleTag_DarkPresenceHeal
		UpgradeRequired			= Upgrade_GondorStableLevel2
		EffectRadius			= 350
		PingDelay				= 4000
		HealPercentPerSecond	= 0.5%
		AllowFilter				= ANY +OathswornWarrior +OathswornBanner +AngmarSnaga +GuldurOrcRavagerBanner +GuldurTombGuard +GuldurOrcRavager +GuldurBrokenRabble +GuldurOrcArcher +GuldurOrcPikeman +GuldurOrcPikemanForBrokenRabble +GuldurBannerOrc
		NonStackable			= Yes
		;HealFX					= FX_SpellHealUnitHealBuff
	End
//--------------------------------------------------------------------------

	Behavior = CitadelSlaughterHordeContain ModuleTag_SlaughterMe
		PassengerFilter					= ANY +INFANTRY +CAVALRY +MordorWorker AOTR_COMBO_HORDES_POS -HERO -DOZER -SUMMONED -GuldurShadeDecoy ;GENERIC_FACTION_SLAUGHTERABLE
		ObjectStatusOfContained			= UNSELECTABLE ENCLOSED
		CashBackPercent					= 200%
		ContainMax						= 99	;// give it a huge capacity, just in case player sends his whole army in at once
		AllowEnemiesInside				= No
		AllowAlliesInside				= No
 		AllowNeutralInside				= No
 		AllowOwnPlayerInsideOverride	= Yes
		EnterSound						= GUI_RingReturned
		EntryOffset						= X:125.0 Y:0.0 Z:0.0
		EntryPosition					= X:80.0 Y:0.0 Z:0.0		// entry position needs to be offset from the root transform, otherwise fortress obscures point.

		ExitOffset						= X:125.0 Y:0.0 Z:0.0
		StatusForRingEntry				= HOLDING_THE_RING
		;StatusForRingEntry				= USER_DEFINED_2
		UpgradeForRingEntry				= Upgrade_RingHero Upgrade_FortressRingHero
		ObjectToDestroyForRingEntry		= NONE +TheDroppedRing
		FXForRingEntry					= FX_OneRingFlare
	End

	Behavior = AttributeModifierAuraUpdate ModuleTag_GiveTheRingToNecromancer
		StartsActive			= No ;Yes ;If no, requires upgrade to turn on.
		Permanent				= No
		BonusName				= NecromancerGetsTheRing
		TriggeredBy				= Upgrade_FortressRingHero
		RefreshDelay			= 2000
		Range					= 99999
		ObjectFilter			= NONE +GuldurNecromancer +GuldurNecromancer_WOTR SAME_PLAYER
	End

	Behavior = AttributeModifierAuraUpdate ModuleTag_GiveTheRingToWitchking
		StartsActive			= No ;Yes ;If no, requires upgrade to turn on.
		Permanent				= No
		BonusName				= WitchKingGetsTheRing
		TriggeredBy				= Upgrade_FortressRingHero
		RefreshDelay			= 2000
		Range					= 99999
		ObjectFilter			= NONE +AngmarWitchking SAME_PLAYER
	End

	;//Spines improvement
;	Behavior = ModelConditionUpgrade ModuleTag_ShowRazorSpines
;		TriggeredBy				= Upgrade_WildFortressRazorSpines
;		AddConditionFlags		= FORTRESS_IMPROVEMENT_4
;		AddTempConditionFlag	= ModelConditionState:USER_2
;		TempConditionTime		= 5.0
;		Permanent				= Yes
;	End

	Behavior = SubObjectsUpgrade ModuleTag_ShowSpikes
		TriggeredBy		= Upgrade_WildFortressRazorSpines
		ShowSubObjects	= SPIKES
	End

	Behavior = DamageFieldUpdate ModuleTag_RazorSpinesWeapon
		Radius			= 100
		ObjectFilter	= ALL ENEMIES
		RequiredUpgrade	= Upgrade_WildFortressRazorSpines

		FireWeaponNugget
			WeaponName		= RazorSpinesBasicWeapon
			FireDelay		= 0
			OneShot			= No
		End
	End

	;//Money Maker
	Behavior = AutoDepositUpdate AutoDepositModuleTag
		DepositTiming       	= GENERIC_KEEP_MONEY_TIME
		DepositAmount       	= GENERIC_KEEP_MONEY_AMOUNT
		InitialCaptureBonus 	= 0  ;// no initial bonus
	End

	Behavior = TerrainResourceBehavior ModuleTag_NewMoneyDeadSpot
		Radius			= GENERIC_KEEP_MONEY_RANGE	;// How far we try to claim ground
		MaxIncome		= 0							;// If we were to get all we wanted, how much we would earn.  Linear slope to 0 at 0% claim
		IncomeInterval	= 999999					;// How often (in msec) we give that much money
		HighPriority	= Yes						;// A high priority claim gets to pretend it was there first.
	End

	#include "..\..\..\FortressRingFunc.inc"

	;//////////////////////////////
	;/// AI-ONLY RING FUNCTION - towers can give the fortress the ring due to return behavior 
	;/////////////////////////////

	Behavior = CreateObjectDie ModuleTag_DropTheRingForTheAI
		CreationList	= OCL_TheOneRing
		
		; Needs both the player and object versions to create a ring when destroyed.
		UpgradeRequired	= Upgrade_MiniHordeLvl4
	End

	Behavior = ModelConditionUpgrade ModuleTag_ForFXForTheAI
		TriggeredBy			= Upgrade_MiniHordeLvl4
	;	RequiresAllTriggers	= Yes
		AddConditionFlags	= ONE_RING
	End
	
	; Special draw module just for rendering the ring model over the fortress to indicate ownership.
	Draw = W3DScriptedModelDraw ModuleTag_RingFXForTheAI
    	DefaultModelConditionState
      		Model = None
    	End
		
		; Higher version for tall towers.
		ModelConditionState = ONE_RING BUILD_VARIATION_TWO
			Model = EXOneRing_CR
		End

		ModelConditionState = ONE_RING
			Model = EXOneRing
		End
		
	End

	Behavior = AttributeModifierAuraUpdate ModuleTag_GiveTheRingToNecromancerForTheAI
		StartsActive			= No ;Yes ;If no, requires upgrade to turn on.
		Permanent				= No
		BonusName				= NecromancerGetsTheRing
		TriggeredBy				= Upgrade_MiniHordeLvl4
		RefreshDelay			= 2000
		Range					= 99999
		ObjectFilter			= NONE +GuldurNecromancer SAME_PLAYER
	End

	Behavior = ObjectCreationUpgrade ModuleTag_NoMoreRingInTheFort
		TriggeredBy = Upgrade_NecromancerRingHero
		RemoveUpgrade = Upgrade_MiniHordeLvl4
    End

	;//////////////////////////////////////

	#include "..\..\..\Includes\FortressEconomyBonusGrants.inc" ;;,;; Added for 2.1

	;-----------------------------
;OLD Geometry
	; Geometry              	= CYLINDER
  ; GeometryMajorRadius   	= 8.0
  ; GeometryMinorRadius   	= 8.0
  ; GeometryHeight  				= 10.0
	;
	; AdditionalGeometry				= CYLINDER
	; GeometryMajorRadius		= 85.0
	; GeometryHeight			= 200.0

	;NEW Geometry

	;-----------------------------
	Geometry              	= CYLINDER
	GeometryMajorRadius   	= 8.0
	GeometryMinorRadius   	= 8.0
	GeometryHeight  				= 10.0

	AdditionalGeometry				= CYLINDER
	GeometryMajorRadius		= 74.0
	GeometryMinorRadius		= 74.0
	GeometryHeight			= 60.0

	AdditionalGeometry				= CYLINDER
	GeometryMajorRadius		= 60.0
	GeometryMinorRadius		= 60.0
	GeometryHeight			= 100.0

	AdditionalGeometry				= CYLINDER
	GeometryMajorRadius		= 48.0
	GeometryMinorRadius		= 48.0
	GeometryHeight			= 120.0

	AdditionalGeometry				= CYLINDER
	GeometryMajorRadius		= 14.0
	GeometryMinorRadius		= 14.0
	GeometryHeight			= 200.0

	;// 4 towers ----
	AdditionalGeometry				= BOX
	GeometryMajorRadius		= 11.0
	GeometryMinorRadius		= 11.0
	GeometryHeight			= 160.0
	GeometryOffset			= X:31 Y:31 Z:0

	AdditionalGeometry				= BOX
	GeometryMajorRadius		= 11.0
	GeometryMinorRadius		= 11.0
	GeometryHeight			= 160.0
	GeometryOffset			= X:31 Y:-31 Z:0

	AdditionalGeometry				= BOX
	GeometryMajorRadius		= 11.0
	GeometryMinorRadius		= 11.0
	GeometryHeight			= 160.0
	GeometryOffset			= X:-31 Y:31 Z:0

	AdditionalGeometry				= BOX
	GeometryMajorRadius		= 11.0
	GeometryMinorRadius		= 11.0
	GeometryHeight			= 160.0
	GeometryOffset			= X:-31 Y:-31 Z:0
	;///--------

	GeometryIsSmall			= No
	Shadow					= SHADOW_VOLUME
	BuildCompletion			= PLACED_BY_PLAYER

	GeometryContactPoint = X:-48.348	Y:26.9		Z:0			Repair
	GeometryContactPoint = X:47.546		Y:-38.677	Z:0			Repair
	GeometryContactPoint = X:47.546		Y:36.435	Z:0
	GeometryContactPoint = X:-32.763	Y:-46.121	Z:0
	;GeometryContactPoint = X:26.753		Y:26.753	Z:67.933	Swoop
	GeometryContactPoint = X:0			Y:0			Z:190		Swoop

End

//------------------------------------------------------------------------------
//Guldur Fortress
// This is the one object that you would place on a map and that the porter builds.
// It unpacks in to the citadel and the buildplots.  It's an old CampFlag.
Object GuldurFortress

	SelectPortrait = BPGuldurFortress

	Draw = W3DScriptedModelDraw ModuleTag_01

		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes // Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		IdleAnimationState
		End

		;//Need this since the default condition is none
		ModelConditionState = WORLD_BUILDER
			Model	= ubfort_skn
		End

		;//Phantom structure when placing a new building to be build
		ModelConditionState = BUILD_PLACEMENT_CURSOR
			Model	= None
		End

		;//Structure that stays where you will be building until the porter reaches the place to start building.
		ModelConditionState =  PHANTOM_STRUCTURE
			Model	= ubfort_skn
		End

		;//	Animation state for build placement cursor
		AnimationState = BUILD_PLACEMENT_CURSOR
			BeginScript
   				CurDrawableHideSubObject("SORCERY")
   				CurDrawableHideSubObject("ENCROACH")
   				CurDrawableHideSubObject("PALANTIR")
   				CurDrawableHideSubObject("TORCHES")
			EndScript
		End

		;//	Animation state for phantom structure
		AnimationState = PHANTOM_STRUCTURE
			BeginScript
   				CurDrawableHideSubObject("SORCERY")
   				CurDrawableHideSubObject("ENCROACH")
   				CurDrawableHideSubObject("PALANTIR")
   				CurDrawableHideSubObject("TORCHES")
			EndScript
		End

		IdleAnimationState
		End

		ModelConditionState  = RUBBLE
			Model			= ubfort_d2
		End

		AnimationState	= RUBBLE
			EnteringStateFX	= FX_StructureMediumCollapse
		End

		//Build Up
		ModelConditionState = ACTIVELY_BEING_CONSTRUCTED SNOW
			Model			= ubfort_bld
			Texture			= ubruin1.tga ubruin1_snow.tga
		End

		ModelConditionState = ACTIVELY_BEING_CONSTRUCTED
			Model			= ubfort_bld
		End

		AnimationState = ACTIVELY_BEING_CONSTRUCTED
			Animation					= UpAndStill
				AnimationName			= ubfort_bld.ubfort_bld
				AnimationMode			= MANUAL
			End
			ParticleSysBone = NONE GuldurBuildingContructDustCastlesB
			ParticleSysBone = NONE FortressWild
			ParticleSysBone   	= NONE GuldurBuildUpAuraShafts
			ParticleSysBone   	= NONE GuldurBuildUpRocks
			StateName = BeingConstructed
			BeginScript
				CurDrawablePlaySound("GondorBarracksBeginConstruction")
			EndScript
		End
	End

;	;//Door
;	Draw = W3DScriptedModelDraw ModuleTag_DrawDoor
;		DefaultModelConditionState
;			Model = None
;		End
;
;		ModelConditionState   = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
;			Model               = WBFDoor_A
;		End
;
;		AnimationState        = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
;			Animation           = DBFDoor_DRA
;				AnimationName     = WBFDoor_A.WBFDoor_A
;				AnimationMode     = MANUAL
;			End
;			Flags				  = START_FRAME_FIRST
;		End
;	End

  	ArmorSet
		Conditions        = None
  		Armor             = FortressArmor
  		//DamageFX          = StructureDamageFXNoShake
  	End

	Side                = Guldur
	EditorSorting       = STRUCTURE

	PlacementViewAngle = -45 // A -90 makes the door of the base face natural south.  0 would have it to the East.

	MaxSimultaneousOfType = 5 ;;,;; Added for 2.02e (T.C.)

	BuildCost           = 5000 ;WILD_FORTRESS_BUILDCOST
	BuildTime           = WILD_FORTRESS_BUILDTIME

	DisplayName         	= OBJECT:WildFortress

	// *** AUTO RESOLVE DATA ***
	//When fighting an auto-resolve battle, a World Map castle actually becomes this unit
	AutoResolveUnitType = AutoResolveUnit_Fortress

    	AutoResolveBody = AutoResolve_WildFortressBody

    	AutoResolveArmor
    		Armor = AutoResolve_WildFortressArmor
    	End

    	AutoResolveWeapon
    		Weapon = AutoResolve_WildFortressWeapon
    	End

	;// *** AUDIO Parameters ***

	#include "..\..\..\Includes\StandardBuildingEvaEvents.inc"

	VoiceFullyCreated				= EVA:FortressComplete-Builder
	VoiceSelect						= IsengardCitadelSelect
	VoiceSelectUnderConstruction	= BuildingEvilVoiceSelectUnderConstruction

	SoundOnDamaged					= BuildingLightDamageStone
	SoundOnReallyDamaged			= BuildingHeavyDamageStone

	UnitSpecificSounds
		UnderConstruction			= BuildingBigConstructionLoop	;// Built first time
		;//UnderRepairFromDamage	= NoSound						;// Repaired No animation on the building, so don't bother playing sound
		UnderRepairFromRubble		= BuildingBigConstructionLoop	;// Repaired from completely destroyed (not used???)
	End

	ClientBehavior = ModelConditionAudioLoopClientBehavior ModuleTag_PlayCollapseSound
		ModelCondition = REQUIRED:RUBBLE Sound:BuildingSink
	End

	CampnessValue = CAMPNESS_FORTRESS

	// *** ENGINEERING Parameters ***
	RadarPriority       = STRUCTURE
	KindOf              = STRUCTURE SELECTABLE IMMOBILE BASE_FOUNDATION MP_COUNT_FOR_VICTORY BASE_SITE CAN_SEE_THROUGH_STRUCTURE LIVING_WORLD_BUILDING_MIRROR

	Body                        = StructureBody ModuleTag_05
		MaxHealth         		    = WILD_FORTRESS_HEALTH
	End

	Behavior = CastleBehavior ModuleTag_castle
		CastleToUnpackForFaction	= Wild fortress_guldur
		CastleToUnpackForFaction	= Mordor fortress_guldur
		CastleToUnpackForFaction	= Isengard fortress_guldur
		CastleToUnpackForFaction	= Men fortress_guldur
		CastleToUnpackForFaction	= Elves fortress_guldur
		CastleToUnpackForFaction	= Dwarves fortress_guldur
		CastleToUnpackForFaction	= Angmar fortress_guldur
		CastleToUnpackForFaction	= Arnor fortress_guldur
		CastleToUnpackForFaction	= Guldur fortress_guldur

		//Anything that does not fit this filter will be given to the neutral player, so the template can have rocks and props.
		FilterValidOwnedEntries = ANY +STRUCTURE +WALK_ON_TOP_OF_WALL +BASE_FOUNDATION +TACTICAL_MARKER

		MaxCastleRadius 			= 130.0
		InstantUnpack				= Yes
		KeepDeathKillsEverything	= Yes

		EvaEnemyCastleSightedEvent = EnemyFortressSighted
	End

	Behavior                  = StructureCollapseUpdate ModuleTag_06
		MinCollapseDelay        = 000
		MaxCollapseDelay        = 000
		CollapseDamping         = .5
		MaxShudder              = 0.6
		MinBurstDelay           = 250
		MaxBurstDelay           = 800
		BigBurstFrequency       = 4
		FXList                  = INITIAL   FX_FortressCollapse
		;FXList                  = ALMOST_FINAL  FX_FortressCollapse
		DestroyObjectWhenDone	= Yes
		CollapseHeight			= 120
	End

	Behavior                  = BuildingBehavior BuildingModuleTag
		NightWindowName         = LIGHTS
		;FireWindowName          = WINDOW_F01
	End

	Behavior	= GettingBuiltBehavior ModuleTag_GettingBuiltBehavior
		WorkerName	= GuldurWorkerNoSelect
		SpawnTimer	= DEFAULT_STRUCTURE_HEALDELAY
	End

	Behavior = AIUpdateInterface ModuleTag_AI
		AILuaEventsList				= GuldurFortressFunctions
	End



	#include "killingshademechanic.inc"

	//Main
	Geometry				= CYLINDER
    GeometryName			= Geom_Orig
  	GeometryMajorRadius		= 84.0
	GeometryMinorRadius		= 84.0
	GeometryHeight			= 60.0

	; Geometry				= CYLINDER
  ;   GeometryName			= Geom_Orig
  ; 	GeometryMajorRadius		= 10.0
	; GeometryMinorRadius		= 10.0
	; GeometryHeight			= 10.0

	//Plot locations
	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:78.0 Y:-36.5 Z:0

	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:78.0 Y:36.5 Z:0

	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:38.5 Y:74.48 Z:0

	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:-38.5 Y:-74.48 Z:0

	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:-38.5 Y:74.48 Z:0

	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:38.5 Y:-74.48 Z:0

	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:-78.0 Y:-36.5 Z:0

	AdditionalGeometry		= BOX
	GeometryName			= Plots
	GeometryMajorRadius		= 10.0
	GeometryMinorRadius		= 10.0
	GeometryHeight			= 0.8
	GeometryOffset			= X:-78.0 Y:36.5 Z:0


	GeometryIsSmall     	= No
	Shadow					= SHADOW_VOLUME

	GeometryContactPoint = X:-55	Y:55		Z:0			Repair
	GeometryContactPoint = X:55		Y:-55	Z:0			Repair
	GeometryContactPoint = X:47.546		Y:36.435	Z:0
	GeometryContactPoint = X:-32.763	Y:-46.121	Z:0
	GeometryContactPoint = X:26.753		Y:26.753	Z:67.933	Swoop
End

ChildObject GuldurFortress_DE GuldurFortress
	EquivalentTo = GuldurFortress
	BuildCost = 5000
End

;------------------------------------------------------------------------------ ;;.;;
Object GuldurFortressBlightCompromiseWeapon
	Draw = W3DScriptedModelDraw ModuleTag_Draw
		DefaultModelConditionState
			Model           = None
		End
	End

	EditorSorting   = SYSTEM
	KindOf = NO_COLLIDE IMMOBILE UNATTACKABLE INERT
	;ForceLuaRegistration = Yes ; I have no AI, but I want to send a fear message so please register me.


	; *** ENGINEERING Parameters ***
	Body = ImmortalBody ModuleTag_02
		MaxHealth = 1
		InitialHealth = 1
	End


	;Behavior = DeletionUpdate ModuleTag_03 ; Not LifetimeUpdate, since I can't die.  This will DestroyObject me.
	;	MinLifetime = BLIGHT_EFFECT_DURATION
	;	MaxLifetime = BLIGHT_EFFECT_DURATION
	;End

	;Behavior = AttributeModifierAuraUpdate ModuleTag_DreadVisage
	;	StartsActive			= Yes
	;	BonusName				= SpellBookBlight
	;	RefreshDelay			= 2000
	;	Range					= BLIGHT_EFFECT_RADIUS
	;	TargetEnemy				= Yes
;;,;;		AntiCategory	= LEADERSHIP BUFF ; This means cancel all previous leadership bonuses
	;	ObjectFilter			= BLIGHT_TYPE_SPELL_OBJECT_FILTER
	;End

;***NOTE: If we can set up the initial weapon to fire ten times, once every ten seconds, then we can considerably clean up the FireWeaponUpdate behavior ;;.;;

	Behavior = FireWeaponUpdate ModuleTag_DamageHandler
		FireWeaponNugget
			WeaponName	= GuldurFortressBlightWeapon
			Offset 		= X:0 Y:0 Z:0
			FireDelay	= 0
			OneShot		= No
		End
	End
End

Object AotRGuldurFortressKeep

  ; *** ART Parameters ***

  SelectPortrait  =  BPGuldurFortress

  Draw = W3DScriptedModelDraw ModuleTag_01
	StaticModelLODMode		= yes ;// Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model = ubfort_skn
		End

		;//	Animation state for build placement cursor
		AnimationState = BUILD_PLACEMENT_CURSOR
			BeginScript
   				CurDrawableHideSubObject("SORCERY")
   				CurDrawableHideSubObject("ENCROACH")
   				CurDrawableHideSubObject("PALANTIR")
   				CurDrawableHideSubObject("TORCHES")
			EndScript
		End

		;//	Animation state for phantom structure
		AnimationState = PHANTOM_STRUCTURE
			BeginScript
   				CurDrawableHideSubObject("SORCERY")
   				CurDrawableHideSubObject("ENCROACH")
   				CurDrawableHideSubObject("PALANTIR")
   				CurDrawableHideSubObject("TORCHES")
			EndScript
		End

;------------Build Up States
    ModelConditionState   = ACTIVELY_BEING_CONSTRUCTED ;PARTIALLY_CONSTRUCTED
      Model               = ubfort_bld
;      ParticleSysBone	  = NONE BuildingDoughnutCloud
      ParticleSysBone     = NONE BuildingContructDust
    End

	AnimationState          = ACTIVELY_BEING_CONSTRUCTED
		Animation
			AnimationName	= ubfort_bld.ubfort_bld
			AnimationMode   = MANUAL
		End
		BeginScript
;			CurDrawableHideSubObject("FIRE02")
		EndScript
	End

  	;--damaged building

		ModelConditionState  = DAMAGED
			Model         = ubfort_d1
			ParticleSysBone FXbone SmokeBuildingLarge
			ParticleSysBone FXbone CastleExplosion
			ParticleSysBone FXbone CatapultDestroyExplosion
			ParticleSysBone FXbone BuildingDamaged
		End
	    AnimationState =  DAMAGED
		    EnteringStateFX	= FX_BuildingReallyDamaged
		End

		ModelConditionState  = REALLYDAMAGED
			Model         = ubfort_d2
			ParticleSysBone FXbone SmokeBuildingLarge
			ParticleSysBone FXbone CastleExplosion
		End
		AnimationState = REALLYDAMAGED
			EnteringStateFX	= FX_BuildingReallyDamaged
		End

   	 	ModelConditionState  = COLLAPSING
      			Model         = ubfort_ruin
			    ;ParticleSysBone FXbone01 BaradDurWave
     			;ParticleSysBone FXbone02 BaradDurDust01 FollowBone:Yes
      			ParticleSysBone FXbone03 CastleExplosion
      			ParticleSysBone FXbone03 CatapultDestroyExplosion
      			ParticleSysBone FXbone03 BuildingDamaged

    	End
;    	AnimationState = COLLAPSING
;      		Animation			=	RubbleAnimation
;				AnimationName		=	 DGBCastle_D4SK.DGBCastle_D4AN
;				AnimationMode		=	ONCE
;				AnimationSpeedFactorRange	= 3.0	3.0

;  			End
;			EnteringStateFX	= FX_DGBCastleCollapse
;    	End

		ModelConditionState  = RUBBLE
			Model         = ubfort_ruin
		End
		AnimationState = RUBBLE
		End

		ModelConditionState  = POST_RUBBLE
			Model         = None
		End
		AnimationState = POST_RUBBLE
		End

		ModelConditionState  = POST_COLLAPSE
			Model         = None
		End
		AnimationState = POST_COLLAPSE
		End
  End

  ; *** AUDIO Parameters ***

	#include "..\..\..\Includes\StandardBuildingEvaEvents.inc"

	VoiceSelect						= MordorFortressSelect
	VoiceSelectUnderConstruction	= BuildingEvilVoiceSelectUnderConstruction

	SoundAmbientDamaged			= GenericFireMediumLoop
	SoundAmbientReallyDamaged	= GenericFireLargeLoop
	SoundOnDamaged				= BuildingLightDamageStone
	SoundOnReallyDamaged		= BuildingHeavyDamageStone

  UnitSpecificSounds
    UnderConstruction		= BuildingConstructionLoop  ; Built first time
	; UnderRepairFromDamage	= NoSound					; Repaired No animation on the building, so don't bother playing sound
	UnderRepairFromRubble	= BuildingConstructionLoop	; Repaired from completely destroyed (not used???)
  End

  ClientBehavior = ModelConditionAudioLoopClientBehavior ModuleTag_PlayCollapseSound
		ModelCondition = REQUIRED:RUBBLE Sound:BuildingSink
  End

  ; ***DESIGN parameters ***
	DisplayName		= OBJECT:DolGoldurCastle
	Side			= Guldur
	EditorSorting	= STRUCTURE
	ThreatLevel		= 1.0
	BuildCost		= 5000
	BuildTime		= 120.0		; in seconds
	VisionRange		= 400
	ShroudClearingRange 	= 800

	ArmorSet
		Conditions	= None
		Armor		= FortressArmor
		DamageFX	= None
	End

	CommandSet		= EmptyCommandSet

  ; *** ENGINEERING Parameters ***
	KindOf			= VITAL_FOR_BASE_SURVIVAL PRELOAD SELECTABLE STRUCTURE IMMOBILE SCORE CASTLE_KEEP MP_COUNT_FOR_VICTORY CAN_ATTACK FS_FACTORY AUTO_RALLYPOINT DOZER_FACTORY NEVER_CULL_FOR_MP COMMANDCENTER DONT_HIDE_IF_FOGGED
	RadarPriority		= STRUCTURE
	KeepSelectableWhenDead	= Yes

	#include "..\..\..\AotRFortressCommandsetsRepair.inc"

	//Used for hero revival and initial construction
	Behavior 		= ProductionUpdate ProductionUpdateModuleTag
		GiveNoXP 	= Yes
	End
	Behavior = QueueProductionExitUpdate QueueProductionModuleTag
		UnitCreatePoint		= X:15.0 Y:0.0 Z:0.0
		NaturalRallyPoint	= X:100.0 Y:0.0 Z:0.0
		ExitDelay			= 50
	End

	Behavior = AIUpdateInterface ModuleTag_AI
		AILuaEventsList				= GuldurFortressKeepFunctions
		AutoAcquireEnemiesWhenIdle	= Yes
		MoodAttackCheckRate			= 250
	End

	Behavior = GettingBuiltBehavior GetBuiltBehaviorTag
		SelfBuildingLoop		= BuildingConstructionLoop		; Only played if we DON'T spawn a worker
		SelfRepairFromDamageLoop	= NoSound				; This doesn't cause an animation, so don't bother playing a sound
		SelfRepairFromRubbleLoop	= BuildingConstructionLoop
		SpawnTimer			= -1.0					; Negative means no 'autoheal'
		RebuildTimeSeconds		= 120
	End

	Body = StructureBody ModuleTag_05
		MaxHealth			= MONUMENT_FORTRESS_HEALTH
		MaxHealthDamaged		= MONUMENT_FORTRESS_HEALTH_DAMAGED
		MaxHealthReallyDamaged		= MONUMENT_FORTRESS_HEALT_REALLY_DAMAGED
  	End

	; Note that structures with "RUBBLE" states should not use DestroyDie; such buildings are
	; never truly destroyed, even when reduced to zero health. Also note that garrisonable
	; buildings automatically stick around because GarrisonContain has it's own DieModule
	Behavior = KeepObjectDie ModuleTag_IWantRubble
	End

	//Money Maker
	Behavior = AutoDepositUpdate AutoDepositModuleTag
		DepositTiming       		= GENERIC_KEEP_MONEY_TIME
		DepositAmount       		= GENERIC_KEEP_MONEY_AMOUNT
		InitialCaptureBonus 		= 0  // no initial bonus
	End

  	Behavior = AttributeModifierUpgrade ModuleTag_WotrIncomeBonus
		TriggeredBy			= Upgrade_WOTRMode
		AttributeModifier	= WotRFortressMapsIncomeBoost
	End

	Behavior = AttributeModifierUpgrade ModuleTag_WotrIncomeBonusAI
		TriggeredBy			= Upgrade_WOTRMode Upgrade_ObjectUnderAIControl
		RequiresAllTriggers	= Yes
		AttributeModifier	= WotRAIEcoBoost
	End

	Behavior = TerrainResourceBehavior ModuleTag_NewMoneyDeadSpot
		Radius					= GENERIC_KEEP_MONEY_RANGE		; How far we try to claim ground
		MaxIncome				= 0					; If we were to get all we wanted, how much we would earn.  Linear slope to 0 at 0% claim
		IncomeInterval			= 999999				; How often (in msec) we give that much money
		HighPriority			= Yes					; A high priority claim gets to pretend it was there first.
	End

	Behavior = CitadelSlaughterHordeContain ModuleTag_SlaughterMe
		PassengerFilter					= GENERIC_FACTION_SLAUGHTERABLE
		ObjectStatusOfContained			= UNSELECTABLE ENCLOSED
		CashBackPercent					= 200%
		ContainMax						= 99						;// give it a huge capacity, just in case player sends his whole army in at once
		AllowEnemiesInside				= No
		AllowAlliesInside				= No
 		AllowNeutralInside				= No
 		AllowOwnPlayerInsideOverride	= Yes
		EnterSound						= MordorSlaughterhouseEnterSound
		EntryOffset						= X:0.0 Y:-100.0 Z:0.0
		EntryPosition					= X:0.0 Y:-50.0 Z:0.0		// entry position needs to be offset from the root transform, otherwise fortress obscures point.

		ExitOffset						= X:-150.0 Y:0.0 Z:0.0
		StatusForRingEntry				= HOLDING_THE_RING
		;StatusForRingEntry				= USER_DEFINED_2
		UpgradeForRingEntry				= Upgrade_RingHero Upgrade_FortressRingHero ;;,;; CE graphics fix
		ObjectToDestroyForRingEntry		= NONE +TheDroppedRing
		FXForRingEntry					= FX_OneRingFlare
	End


	Behavior = AttributeModifierAuraUpdate ModuleTag_GiveTheRingToSaruman
		StartsActive			= No ;Yes ;If no, requires upgrade to turn on.
		Permanent				= No
		BonusName				= SarumanGetsTheRing
		TriggeredBy				= Upgrade_FortressRingHero
		RefreshDelay			= 2000
		Range					= 99999
		ObjectFilter			= NONE +IsengardSaruman SAME_PLAYER
	End

	Behavior = AttributeModifierAuraUpdate ModuleTag_GiveTheRingToNecromancer
		StartsActive			= No ;Yes ;If no, requires upgrade to turn on.
		Permanent				= No
		BonusName				= NecromancerGetsTheRing
		TriggeredBy				= Upgrade_FortressRingHero
		RefreshDelay			= 2000
		Range					= 99999
		ObjectFilter			= NONE +GuldurNecromancer SAME_PLAYER
	End
	Behavior = AttributeModifierAuraUpdate ModuleTag_GiveTheRingToWitchking
		StartsActive			= No ;Yes ;If no, requires upgrade to turn on.
		Permanent				= No
		BonusName				= WitchKingGetsTheRing
		TriggeredBy				= Upgrade_FortressRingHero
		RefreshDelay			= 2000
		Range					= 99999
		ObjectFilter			= NONE +AngmarWitchking SAME_PLAYER
	End
	
	Behavior = AttributeModifierAuraUpdate ModuleTag_GiveTheRingToBalrog
		StartsActive			= No ;Yes ;If no, requires upgrade to turn on.
		Permanent				= No
		BonusName				= BalrogGetsTheRing
		TriggeredBy				= Upgrade_FortressRingHero
		RefreshDelay			= 2000
		Range					= 99999
		ObjectFilter			= NONE +MoriaDurinsBane SAME_PLAYER
	End
	
	Behavior = AttributeModifierAuraUpdate ModuleTag_GiveTheRingToBilbo
		StartsActive			= No ;Yes ;If no, requires upgrade to turn on.
		Permanent				= No
		BonusName				= BilboGetsTheRing
		TriggeredBy				= Upgrade_FortressRingHero
		RefreshDelay			= 2000
		Range					= 99999
		ObjectFilter			= NONE +HeroBilboBotfa SAME_PLAYER
	End	

	#include "..\..\..\AOTRfortressupgrades.inc"

	#include "..\..\..\includes\FortressEconomyBonusGrants.inc" ;;,;; Added for 2.1

	#include "..\..\..\FortressRingFunc.inc"

	Geometry				= CYLINDER
	GeometryMajorRadius		= 100
	GeometryHeight			= 200.0

	GeometryIsSmall			= No
	Shadow					= SHADOW_VOLUME
	BuildCompletion			= PLACED_BY_PLAYER

	GeometryContactPoint = X:-48.348	Y:26.9		Z:0			Repair
	GeometryContactPoint = X:47.546		Y:-38.677	Z:0			Repair
	GeometryContactPoint = X:47.546		Y:36.435	Z:0
	GeometryContactPoint = X:-32.763	Y:-46.121	Z:0
	;GeometryContactPoint = X:26.753		Y:26.753	Z:67.933	Swoop
	GeometryContactPoint = X:0			Y:0			Z:190		Swoop
End

Object GuldurFortressFellStorm

	Draw = W3DScriptedModelDraw ModuleTag_DrawMist
		DefaultModelConditionState
			Model				= None
			ParticleSysBone		= NONE IceWallMist				;EnshroudingMist
			ParticleSysBone		= NONE IceWallMist02			;EnshroudingMist
			ParticleSysBone		= NONE FrozenLandEmbers30	;EnshroudingMist
			ParticleSysBone		= NONE FrozenLandWhirl			;EnshroudingMist
		End
	End


	EvaEnemyObjectSightedEvent = None  ; Not a real unit

	; ***DESIGN parameters ***
	VisionRange     = 0.0
	EditorSorting   = SYSTEM
	KindOf			= NO_COLLIDE UNATTACKABLE IGNORE_FOR_VICTORY IGNORE_FOR_EVA_SPEECH_POSITION MOVE_ONLY
	ThreatLevel		= 0

	; *** ENGINEERING Parameters ***
	Body = ActiveBody ModuleTag_01
		MaxHealth		= 999999
		InitialHealth	= 999999
	End

	Behavior = LifetimeUpdate ModuleTag_LifetimeUpdate
		MinLifetime		= 30000						; 60 seconds
		MaxLifetime		= 30000
	End

	Behavior = AIUpdateInterface	ModuleTag_AIUpdateInterface
		AutoAcquireEnemiesWhenIdle = No
		;// MoodAttackCheckRate		= 250
	End

	Behavior = FireWeaponUpdate ModuleTag_KhamulField
			FireWeaponNugget
				WeaponName = GuldurFellStormWeapon	;ChillofAngmarWeapon
				FireDelay = 0
				OneShot = No
			End
	End

End

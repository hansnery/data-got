;------------------------------------------------------------------------------
;Elven Mallorn Tree
Object ElvenNiphredilMallornTree
	SelectPortrait = BPLorienMallornTree
  Draw = W3DScriptedModelDraw ModuleTag_Draw
		OkToChangeModelColor  = Yes
		StaticModelLODMode = yes
		UseStandardModelNames = Yes


		DefaultModelConditionState
			Model = ebNmallorn1_nip  ;EBMalTree
			; ParticleSysBone     =  FireFlyBone FireFlies02 FollowBone:Yes
		    ;WeaponLaunchBone = PRIMARY ARCHER01
		End

		ModelConditionState = USER_28
			Model = ebNmallorn1_nip  ;EBMalTree
			ParticleSysBone  = None TollKeepersAura Followbone:No
			ParticleSysBone  = None TollKeepersGold Followbone:No
			ParticleSysBone  = None TollKeepersGreen Followbone:No
		End

		ModelConditionState = USER_29
			Model =ebNmallorn1_nip  ;EBMalTree
			ParticleSysBone  = None CursedTreasureAura Followbone:No
			ParticleSysBone  = None CursedTreasureGold Followbone:No
			ParticleSysBone  = None CursedTreasureGreen Followbone:No
		End

	ModelConditionState				= BUILD_PLACEMENT_CURSOR
		Shadow						= SHADOW_ALPHA_DECAL
		ShadowTexture				= decal_hero_good
		ShadowSizeX					= 385 ;ELVEN_STATUE_AOE_RADIUS_DECAL
		ShadowSizeY					= 385 ;ELVEN_STATUE_AOE_RADIUS_DECAL
		ShadowOverrideLODVisibility = Yes
	End
	;//	Animation state for build placement cursor
	AnimationState = BUILD_PLACEMENT_CURSOR
		BeginScript
			CurDrawableHideSubObject("N_Window")
			CurDrawableHideSubObject("N_Glow")
   			CurDrawableHideSubObject("V1")
   			CurDrawableHideSubObject("V1a")
			CurDrawableHideSubObject("V2")
			CurDrawableHideSubObject("V2a")
		EndScript
	End
	;//	Animation state for phantom structure
	AnimationState = PHANTOM_STRUCTURE
		BeginScript
			CurDrawableHideSubObject("N_Window")
			CurDrawableHideSubObject("N_Glow")
   			CurDrawableHideSubObject("V1")
   			CurDrawableHideSubObject("V1a")
			CurDrawableHideSubObject("V2")
			CurDrawableHideSubObject("V2a")
		EndScript
	End
    IdleAnimationState
		ParticleSysBone = NONE LorienFallingLeaves
		ParticleSysBone = NONE FireFliesLorien	
	End
    ;------------ Build Up States -------
 ;   ModelConditionState = SNOW AWAITING_CONSTRUCTION
;		Model	= ebNmallorn0_bld  ;EBMalTree_ASKN
;		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
;		Texture = ebNmallornA.tga ebNmallornA_snow.tga
;	End
 ;   ModelConditionState   = AWAITING_CONSTRUCTION
 ;     Model               = ebNmallorn0_bldEBMalTree_ASKN
;;		ParticleSysBone	  = NONE BuildingDoughnutCloud
 ;   End
 ;   AnimationState        = AWAITING_CONSTRUCTION
 ;;     Animation           =  ebNmallorn0_bld  ;EBMalTree_A
 ;       AnimationName     =  ebNmallorn0_bld.ebNmallorn0_bld  ;EBMalTree_ASKL.EBMalTree_ABLD
 ;       AnimationMode     = MANUAL
 ;       AnimationBlendTime = 0
 ;     End
;	  Flags				  = START_FRAME_FIRST
 ;   End
;	ModelConditionState = SNOW ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
;		Model	= ebNmallorn0_bld   ;EBMalTree_ASKN
;		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
;		Texture = ebNmallornA.tga ebNmallornA_snow.tga
;	End
;    ModelConditionState   = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
;      Model               = ebNmallorn0_bld  ;EBMalTree_ASKN
;		ParticleSysBone   = CONSTDUSTBONE01 BuildingContructDust FollowBone:Yes
;		ParticleSysBone = NONE ExpLeavesLorien
; ;   End;
;    AnimationState        = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
;		Animation           = ebNmallorn0_bld  ;EBMalTree_A
;			AnimationName     = ebNmallorn0_bld.ebNmallorn0_bld  ;EBMalTree_ASKL.EBMalTree_ABLD
;			AnimationMode     = MANUAL
;			AnimationBlendTime = 0
;		End
;;		Flags				  = START_FRAME_FIRST
;		StateName				= BeingConstructed
;		BeginScript
;			CurDrawablePlaySound("GondorBarracksBeginConstruction")
;		EndScript
 ;   End
      ;--damaged building
		ModelConditionState     = DAMAGED
			Model               = ebNmal1_nip_d1  ;EBMalTree_D1
		End
		AnimationState =	DAMAGED
			EnteringStateFX	= FX_StatueDamaged
			ParticleSysBone = NONE LorienBaseLeaves
			ParticleSysBone = NONE Maltreedust
		End
		ModelConditionState     = REALLYDAMAGED
			Model               = ebNmal1_nip_d2  ;EBMalTree_D2
		End
    	AnimationState =	REALLYDAMAGED
    		Animation	= RubbleAnimation
				AnimationName		=	ebNmal1_nip_d2.ebNmal1_nip_d2  ;EBMalTree_D2SK.EBMalTree_D2AN
				AnimationMode		=	ONCE
	  		End
			EnteringStateFX	= FX_StatueDamaged
		End
		ModelConditionState  = RUBBLE
			Model         =  ebNmal1_nip_d2    ;EBMalTree_D3
			ParticleSysBone SmokeLarge01 SmokeBuildingLarge
		End
		AnimationState = RUBBLE
			Animation	= RubbleAnimation
				AnimationName		=	ebNmal1_nip_d2.ebNmal1_nip_d2   ;EBMalTree_D3SK.EBMalTree_D3AN
				AnimationMode		=	ONCE
	  		End
	  		EnteringStateFX	= FX_StructureMediumCollapse
		End
		ModelConditionState  = POST_RUBBLE
			Model         = None
			ParticleSysBone NONE SmokeBuildingMediumRubble
		End
		ModelConditionState  = POST_COLLAPSE
			Model         = None
			ParticleSysBone NONE SmokeBuildingMediumRubble
		End

	    ModelConditionState = SNOW
			Model = ebNmallorn1_nip  ;EBMalTree
		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
		Texture = ebNmallornA.tga ebNmallornA_snow.tga
        End
  End

 	//Mallorn Roots
	Draw = W3DScriptedModelDraw ModuleTag_DrawMallornRoots
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		//Normal
		ModelConditionState = UPGRADE_NUMENOR_STONEWORK
			Model           = ebNmallorn2_roo  ;ebmalroots_skn
		End
	End
 	//Star-lit Lanterns
	Draw = W3DScriptedModelDraw ModuleTag_DrawStarlitLanterns
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD
		ExtraPublicBone = B_LANTERN01
		ExtraPublicBone = B_LANTERN02
		ExtraPublicBone = B_LANTERN03
		ExtraPublicBone = B_LANTERN04
		ExtraPublicBone = B_LANTERN05


		DefaultModelConditionState
			Model           = None
		End

		//Normal
		ModelConditionState = USER_3
			Model           = ebNmallorn2_lan
		End
	End
 	//Silvan Levy
	Draw = W3DScriptedModelDraw ModuleTag_DrawSilvanLevy
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		//Normal
		ModelConditionState = USER_6
			Model           = ebNmallorn2_sil
		End
	End
	Draw = W3DScriptedModelDraw ModuleTag_DrawNiphredilBloom2
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		//Normal
		ModelConditionState = USER_8
			Model           = ebNmall1_nip3
		End
		ModelConditionState     = USER_8 DAMAGED
			Model               = ebNmall1_nip3  ;EBMalTree_D1
			Texture =			ebNmallornA.tga ebNmallornA_D.tga
		End

	End
 	//Niphredil Bloom rank 3
	Draw = W3DScriptedModelDraw ModuleTag_DrawNiphredilBloom3
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		//Normal
		ModelConditionState = USER_9
			Model           = ebNmall1_nip4
		End

		ModelConditionState = USER_9 DAMAGED
			Model           = ebNmall1_nip4
			Texture =			ebNgarrison_d.tga ebNgarrison_d.tga
		End
	End
	Draw = W3DScriptedModelDraw ModuleTag_DrawArrowBones
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD
		ExtraPublicBone = MALARROW01
		ExtraPublicBone = MALARROW02
		ExtraPublicBone = MALARROW03
		ExtraPublicBone = MALARROW04

		DefaultModelConditionState
			Model           = ebNarrows_skn
			WeaponLaunchBone = PRIMARY MALARROW
		End
	End	
  ; Draw module just for the hero FX.
	Draw = W3DScriptedModelDraw TheHealEffect
	    ModelConditionState  = NONE
			Model = None
	;		ParticleSysBone NONE StatueHeroFX
		End
	    ModelConditionState  = ACTIVELY_BEING_CONSTRUCTED
			Model = None
		End
	End
  Draw = W3DFloorDraw ModuleTag_DrawFloor
		StaticModelLODMode = Yes		; THIS NEEDS TO BE COMMENTED OUT WHEN ENGINEERING ENABLES LOD'S IN THE FLOOR DRAW
     ModelName = ebNmallorn0_bib  ;EBMalTree_Bib
	WeatherTexture		= SNOWY ebNmallorn_bib_snow.tga ;eblothfort_bib_snow
  		;HideIfModelConditions	=	AWAITING_CONSTRUCTION
  		;HideIfModelConditions	=	PARTIALLY_CONSTRUCTED
  End
;  Draw = W3DScriptedModelDraw ModuleTag_Draw_HCBanner
;	OkToChangeModelColor  = Yes
;	DefaultModelConditionState
;		Model = EBHCMalTree
;	End
;	MultiPlayerOnly = Yes
;  End
	Draw = W3DScriptedModelDraw Draw_BonusEffects
	    DefaultModelConditionState
	      Model = None
	    End
	    AnimationState = ACTIVELY_BEING_CONSTRUCTED
	    End
		AnimationState = UPGRADE_ECONOMY_BONUS
			ParticleSysBone	= None FueltheFiresEmbers
		End
		AnimationState = USER_5 ;;,;; Added for 2.02e (T.C.) - Grand Harvest particle system
			ParticleSysBone	= None MirrorofGaladrielMallornSparkle
		End
		AnimationState = USER_5 UPGRADE_ECONOMY_BONUS ;;,;; Added for 2.02e (T.C.)
			ParticleSysBone	= None FueltheFiresEmbers
		End
		AnimationState = USER_4
			ParticleSysBone	= None StoneWorkerFX ; WellHealFX
		End
		AnimationState = USER_4 UPGRADE_ECONOMY_BONUS
			ParticleSysBone	= None FueltheFiresEmbers
		End
		AnimationState = USER_4 USER_5
			ParticleSysBone	= None FueltheFiresEmbers
		End
		AnimationState = USER_4 USER_5 UPGRADE_ECONOMY_BONUS
			ParticleSysBone	= None FueltheFiresEmbers
		End
	End
 PlacementViewAngle  = -45    ; PlacementViewAngle  = 45
  ; ***DESIGN parameters ***
  DisplayName			= OBJECT:ElvenMallornTree
  Description			= OBJECT:NiphredilMallornTreeDescription
  Side					= Elves
  ;IsTrainable			= No
  EditorSorting			= STRUCTURE
  ThreatLevel			= 1.0

  BuildCost           = 200 ;ELVEN_MALLORN_TREE_BUILDCOST
  RefundValue 		  = 163
  BuildTime           = 10 ;ELVEN_MALLORN_TREE_BUILDTIME          ; in seconds
  VisionRange         = ELVEN_MALLORN_TREE_SHROUD_CLEAR          ; Shroud clearing distance
  ShroudClearingRange = ELVEN_MALLORN_TREE_SHROUD_CLEAR
  BountyValue         = 81
  CommandPointBonus	= 0 ;GENERIC_ECONOMY_COMMAND_POINT_BONUS

  CommandSet = LorienMallornTreeCommandSetNiphredilLevel1 ;SellableCommandSet

  ArmorSet
    Conditions        = None
    Armor             = MallornTreeArmor ;ResourceArmor
    ;DamageFX         = StructureDamageFXNoShake
  End

   	WeaponSet
		Conditions			= None
	End

	WeaponSet
		Weapon				= PRIMARY ElvenBattleTowerBow
		Conditions			= PLAYER_UPGRADE
		AutoChooseSources		= PRIMARY FROM_PLAYER FROM_SCRIPT FROM_AI
	End


; For Testing Purposes


	; *** AUDIO Parameters ***
	#include "..\..\..\Includes\StandardBuildingEvaEvents.inc"

	VoiceSelect		= ElfMallornTreeSelect				;GondorStatueSelect

	SoundOnDamaged		= BuildingLightDamageWood
	SoundOnReallyDamaged	= BuildingHeavyDamageWood

	VoiceSelectUnderConstruction	= LothlorienBuildingSelectUnderConstruction
;	VoiceFullyCreated		= EVA:MallornBuildingComplete-Builder-Elf

	UnitSpecificSounds
		UnderConstruction	= LothlorienConstructionLoop  	; Built first time
		; UnderRepairFromDamage	= NoSound			; Repaired No animation on the building, so don't bother playing sound
		UnderRepairFromRubble	= LothlorienConstructionLoop	; Repaired from completely destroyed (not used???)
	End

	EvaEventDamagedOwner		= MallornTreeUnderAttack ;UnderAttackResource

	ClientBehavior = AnimationSoundClientBehavior ModuleTag_AnimAudioBehavior
		MaxUpdateRangeCap = 800
		AnimationSound = Sound:StatueHeroicBuildStoneExplode	Animation:RPHeroStat_A.RPHeroStat_A		Frames:620
		AnimationSound = Sound:StatueHeroicBuildStoneDebris1	Animation:RPHeroStat_A.RPHeroStat_A		Frames:635
		AnimationSound = Sound:StatueHeroicBuildStoneDebris2	Animation:RPHeroStat_A.RPHeroStat_A		Frames:650
	End

 	CampnessValue = CAMPNESS_RESOURCE_BUILDING

  ; *** ENGINEERING Parameters ***

	RadarPriority       = STRUCTURE
	KindOf              = PRELOAD STRUCTURE SELECTABLE IMMOBILE SCORE NEED_BASE_FOUNDATION FS_CASH_PRODUCER MADE_OF_STONE ATTACK_NEEDS_LINE_OF_SIGHT CAN_ATTACK IGNORE_FOR_VICTORY LIVING_WORLD_BUILDING_MIRROR AUTO_RALLYPOINT FS_FACTORY ECONOMY_STRUCTURE ;COMMANDCENTER ;;,;; Added FS_CASH_PRODUCER

	Body                		= StructureBody ModuleTag_05
	  MaxHealth         		= 1800
	  MaxHealthDamaged        	= 1200
	  MaxHealthReallyDamaged  	= 600
	End

	Flammability   ; should be after the 'Body' statement
		Fuel          =   ELVEN_MALLORNTREE_FIRE_FUEL
		MaxBurnRate   =   ELVEN_MALLORNTREE_FIRE_MAX_BURN_RATE
		Decay         =   ELVEN_MALLORNTREE_FIRE_DECAY
		Resistance    =   ELVEN_MALLORNTREE_FIRE_RESISTANCE
    End

	Behavior = SlowDeathBehavior ModuleTag_SlowDeathWithoutRubble
		DestructionDelay  = 5000
	End

	Behavior = AIUpdateInterface ModuleTag_SoWeCanUseWeapon
		AutoAcquireEnemiesWhenIdle	= Yes
		MoodAttackCheckRate			= 250
		AILuaEventsList				= MallornTreeFunctions ;MirkwoodShrineFunctions
	End

	Behavior            = GettingBuiltBehavior GetBuiltBehaviorTag
		WorkerName	= ElvenWorkerNoSelect_LorienSinger
		SpawnTimer	= DEFAULT_STRUCTURE_HEALDELAY
	End

	;fixing blue health bug
	Behavior = AttributeModifierUpgrade ModuleTag_ElvenGiftBonus
		TriggeredBy = Upgrade_ElfFaction
		RequiresAllTriggers = No
		AttributeModifier = BriefImmunity
	End

	Behavior = ProductionUpdate ProductionUpdateModuleTag
	;	GiveNoXP                       = Yes  ;disable granting xp when producing units.
	End

	Behavior = TerrainResourceBehavior ModuleTag_MoneyProduction
		Radius		= 240 ;ELVEN_MALLORN_TREE_MONEY_RANGE	; How far we try to claim ground
		MaxIncome	= 25 ;ELVEN_MALLORN_TREE_MONEY_AMOUNT	; If we were to get all we wanted, how much we would earn.  Linear slope to 0 at 0% claim
		IncomeInterval	= ELVEN_MALLORN_TREE_MONEY_TIME		; How often (in msec) we give that much money
	End

	ClientBehavior = TerrainResourceClientBehavior ModuleTag_MoneyProductionClient
	End

;	Behavior = AttributeModifierAuraUpdate ModuleTag_EcoDebuff
;		StartsActive		= No
;		BonusName		= LothlorienEconomyDebuff
;		TriggeredBy		= Upgrade_ArnorWallRegularGate
;		ConflictsWith	= Upgrade_ArnorWallPosternGate
;		RefreshDelay	= 2000
;		Range			= 10
;		AllowSelf		= Yes
;		ObjectFilter	= NONE +ElvenNiphredilMallornTree ALLIES
;	End

; ;-------------------------------------------------------------------------------------------------------------------
; ;--------------------------------- NEW LIMITED BUILD RADIUS SYSTEM -------------------------------------------------
; ;-------------------------------------------------------------------------------------------------------------------

	; Behavior = WallHubBehavior ModuleTag_WALL_HUB

		; Options = OPTION_ONE
		; MaxBuildoutDistance = 1000 ; ISENGARD_FORTRESS_WALL_EFFECTIVE_RADIUS ;;,;; MEN_FORTRESS_WALL_EFFECTIVE_RADIUS

		; StaggeredBuildFactor = STANDARD_WALL_STAGGERED_BUILD_FACTOR

		; ;;This defines the pattern built on flat terrain
; ;		SegmentTemplateName = IsengardCastleWallSegment
; ;		SegmentTemplateName = IsengardCastleWallSegment
; ;		SegmentTemplateName = IsengardCastleWallSegment
; ;		SegmentTemplateName = IsengardCastleWallSegment
; ;		SegmentTemplateName = IsengardCastleWallSegment
; ;		SegmentTemplateName = IsengardCastleWallHub

		; HubCapTemplateName = ElvenMallornTree ;IsengardCastleWallHub
; ;		DefaultSegmentTemplateName = IsengardCastleWallSegment

; ;		CliffCapTemplateName = IsengardWallCliffCap
		; ;ShoreCapTemplateName = [NAME]
		; ;BorderCapTemplateName = [NAME]
		; ;ElevatedSegmentTemplateName = [NAME]
	; End
; ;-------------------------------------------------------------------------------------------------------------------
; ;-------------------------------------------------------------------------------------------------------------------

	Behavior = QueueProductionExitUpdate QueueProductionModuleTag
		UnitCreatePoint			= X:0.0 Y:0.0 Z:0.0
	;	PlacementViewAngle		= -45
		NaturalRallyPoint		= X:10 Y:10 Z:0.0
		ExitDelay				= STANDARD_HORDE_EXIT_DELAY
		UseReturnToFormation	= No
	End

	Behavior                  = StructureCollapseUpdate ModuleTag_Collapse
		MinCollapseDelay        = 000
		MaxCollapseDelay        = 000
		CollapseDamping         = .5
		MaxShudder              = 0.6
		MinBurstDelay           = 250
		MaxBurstDelay           = 800
		BigBurstFrequency       = 4
		FXList                  = INITIAL   FX_StructureMediumCollapse
		FXList                  = ALMOST_FINAL  FX_StructureAlmostCollapse
		DestroyObjectWhenDone	= Yes
		CollapseHeight		= 126
	End

	Behavior = SubObjectsUpgrade ModuleTag_HideAll
		TriggeredBy		= Upgrade_StructureLevel1
		HideSubObjects		= V1 V1a V2 V2a
	End

	Behavior = SubObjectsUpgrade ModuleTag_ShowTower
		TriggeredBy		= Upgrade_StructureLevel2
		ShowSubObjects		= V2 V2a
	End

  	Behavior = SubObjectsUpgrade ModuleTag_ShowPillarsAndWalls
		TriggeredBy		= Upgrade_StructureLevel3
		ShowSubObjects		= V1 V1a V2 V2a
	End
	;--------------------------------------------------------------------------
	Behavior = GrantUpgradeCreate ModuleTag_GimmeNiphredil
        UpgradeToGrant = Upgrade_MallornTreeNiphredil
        GiveOnBuildComplete = Yes
    End

	Behavior = ModelConditionUpgrade ModuleTag_ShowNiphredilBloom2
		TriggeredBy				= Upgrade_StructureLevel2
		AddConditionFlags		= USER_8
	End
	Behavior = ModelConditionUpgrade ModuleTag_ShowNiphredilBloom3
		TriggeredBy				= Upgrade_StructureLevel3
		AddConditionFlags		= USER_9
	End

	Behavior = WeaponSetUpgrade ModuleTag_ThirdLevelBuildingArrows
			TriggeredBy		= Upgrade_StructureLevel3
	End

	;Behavior = AttributeModifierUpgrade ModuleTag_NiphredilLevel1Bonus
	;	TriggeredBy = Upgrade_MallornTreeNiphredil
	;	AttributeModifier = ElvenMallornTreeNiphredilCPBonus
	;End

	;Behavior = LevelUpUpgrade ModuleTag_NiphredilLevel2
	;	TriggeredBy    = Upgrade_StructureLevel2 ;Upgrade_MallornTreeLevel2
	;	LevelsToGain   = 1
	;	LevelCap       = 3
	;End
	;Behavior = AttributeModifierUpgrade ModuleTag_NiphredilLevel2Bonus
	;	TriggeredBy = Upgrade_StructureLevel2  ;Upgrade_MallornTreeLevel2
	;	AttributeModifier = ElvenMallornTreeBuildSpeedModLvl2
	;End

	;Behavior = LevelUpUpgrade ModuleTag_NiphredilLevel3
	;	TriggeredBy    = Upgrade_StructureLevel3  ;Upgrade_MallornTreeLevel3
	;	LevelsToGain   = 1
	;	LevelCap       = 3
	;End
	;Behavior = AttributeModifierUpgrade ModuleTag_NiphredilLevel3Bonus
	;	TriggeredBy = Upgrade_StructureLevel3  ;Upgrade_MallornTreeLevel3
	;	AttributeModifier = ElvenMallornTreeBuildSpeedModLvl3
	;End
;--------------------------------------------------------------------------
;----------------------- NIPHREDIL COMMANDSET --------------------------------------------------------------------------
;	Behavior = CommandSetUpgrade ModueTag_NiphredilCommandSet
;		TriggeredBy			= Upgrade_MallornTreeNiphredil
;		ConflictsWith       = Upgrade_MallornTreeBarracks Upgrade_MallornTreePasture Upgrade_MallornTreeStorage
;		CommandSet			= LorienMallornTreeCommandSetNiphredilLevel1
;		RequiresAllTriggers	= Yes
;	End
;	Behavior = CommandSetUpgrade ModueTag_NiphredilCommandSetLevel2
;		TriggeredBy			= Upgrade_MallornTreeNiphredil Upgrade_MallornTreeLevel2
;		ConflictsWith       = Upgrade_MallornTreeBarracks Upgrade_MallornTreePasture Upgrade_MallornTreeStorage
;;		CommandSet			= LorienMallornTreeCommandSetNiphredilLevel2
;		RequiresAllTriggers	= Yes
;	End
;	Behavior = CommandSetUpgrade ModueTag_NiphredilCommandSetLevel3
;;		TriggeredBy			= Upgrade_MallornTreeNiphredil Upgrade_MallornTreeLevel3
;		ConflictsWith       = Upgrade_MallornTreeBarracks Upgrade_MallornTreePasture Upgrade_MallornTreeStorage
;		CommandSet			= LorienMallornTreeCommandSetNiphredilLevel3
;		RequiresAllTriggers	= Yes
;	End


;Behavior = SpecialPowerModule ModuleTag_MallornTreeFXStarter
;	SpecialPowerTemplate		= SpecialAbilityMallornTreeReplaceFX
;	UpdateModuleStartsAttack	= Yes
;	StartsPaused				= No
;	TriggerFX					= FX_WarlordTribalSummon
;End

	Behavior = ModelConditionUpgrade ModuleTag_ShowMallornRoots
		TriggeredBy				= Upgrade_MallornTreeRoots
		AddConditionFlags		= UPGRADE_NUMENOR_STONEWORK
	End

	; Behavior = AttributeModifierUpgrade ModuleTag_AIStimulus
		; TriggeredBy				= Upgrade_ObjectUnderAIControl
		; AttributeModifier		= AIStimulusPackage
	; End
	#include "..\..\..\goodfaction\structures\elven\lorienbuildingsubupgrades.inc"

	;----This object grants CP to the Mallorn Tree via Niphredil upgrade
	Behavior = SpawnBehavior ModuleTag_SpawnCommandPoints
		TriggeredBy = Upgrade_MallornTreeNiphredil
		SpawnNumber = 1
		InitialBurst = 1
		SpawnTemplateName = ElvenCommandPointDummy
	;	SpawnReplaceDelay = 35000
		FadeInTime = 100
	;	OneShot = No
	;	SpawnInsideBuilding = No
	;	CanReclaimOrphans	= Yes
	End
	;----These objects generate more CP as the mallorn levels
	Behavior = SpawnBehavior ModuleTag_SpawnMoreCommandPoints
		TriggeredBy = Upgrade_StructureLevel2
		SpawnNumber = 1
		InitialBurst = 1
		SpawnTemplateName = ElvenCommandPointDummy_25
	;	SpawnReplaceDelay = 35000
		FadeInTime = 100
	;	OneShot = No
	;	SpawnInsideBuilding = No
	;	CanReclaimOrphans	= Yes
	End
	Behavior = SpawnBehavior ModuleTag_SpawnEvenMoreCommandPoints
		TriggeredBy = Upgrade_StructureLevel3
		SpawnNumber = 1
		InitialBurst = 1
		SpawnTemplateName = ElvenCommandPointDummy_25
	;	SpawnReplaceDelay = 35000
		FadeInTime = 100
	;	OneShot = No
	;	SpawnInsideBuilding = No
	;	CanReclaimOrphans	= Yes
	End
	;-----------------------------------------------------------------------------
	;	Cargast's Cursed Treasure
	;-----------------------------------------------------------------------------
    Behavior = ObjectCreationUpgrade ModuleTag_CursedTreasure1
		TriggeredBy = Upgrade_CursedTreasureActivated
		RemoveUpgrade = Upgrade_CursedTreasureDesactivated
    End
    Behavior = ObjectCreationUpgrade ModuleTag_CursedTreasure2
		TriggeredBy = Upgrade_CursedTreasureDesactivated
		RemoveUpgrade = Upgrade_CursedTreasureActivated
    End
	Behavior = AttributeModifierUpgrade ModuleTag_CursedTreasure3
		TriggeredBy = Upgrade_CursedTreasureActivated
		ConflictsWith = Upgrade_CursedTreasureDesactivated
		AttributeModifier = GuldurCursedTreasureProductionBuff
	End
	Behavior = AttributeModifierAuraUpdate ModuleTag_CursedTresureDebuff
		StartsActive	= No ;If no, requires upgrade to turn on.
		TriggeredBy		= Upgrade_CursedTreasureActivated
		BonusName		= GuldurCursedTreasureDebuff
		RefreshDelay	= 2000
		Range			= 300
		ObjectFilter	= AOTR_GENERIC_BUFF_RECIPIENT_OBJECT_FILTER
	End
	;-----------------------------------------------------------------------------

	;-----------------------------------------------------------------------------
	;	Grimbeorn's Toll-Keepers
	;-----------------------------------------------------------------------------
	Behavior = OCLSpecialPower ModuleTag_SummonTreasureChest
		SpecialPowerTemplate = SpecialAbilityTollKeepersSummon
		OCL                  = OCL_TollKeepersTreasure
		TriggerFX			 = FX_GenericGoodSummon
		CreateLocation       = USE_OWNER_OBJECT
		StartsPaused		 = No
		UpdateModuleStartsAttack  = Yes
	End
	;-----------------------------------------------------------------------------

	; Behavior = AISpecialPowerUpdate SpellBookIndustryAIUpgrade
	; 	CommandButtonName = Command_PurchaseUpgradeLorienMallornLevel2
	; 	SpecialPowerAIType = AI_SPELLBOOK_BUFFECONOMYBUILDING
	; End

	; Behavior = AISpecialPowerUpdate SpellBookIndustryAIUpgrade2
	; 	CommandButtonName = Command_PurchaseUpgradeLorienMallornLevel3
	; 	SpecialPowerAIType = AI_SPELLBOOK_BUFFECONOMYBUILDING
	; End
	; Behavior = AISpecialPowerUpdate SpellBookIndustryAIUpgrade3
	; 	CommandButtonName = Command_PurchaseMallornRoots
	; 	SpecialPowerAIType = AI_SPELLBOOK_BUFFECONOMYBUILDING
	; End

	; Behavior = AISpecialPowerUpdate SpellBookIndustryAIUpgrade4
	; 	CommandButtonName = Command_PurchaseNimrodelWaters
	; 	SpecialPowerAIType = AI_SPELLBOOK_BUFFECONOMYBUILDING
	; End


	Geometry              = CYLINDER
	GeometryMajorRadius   = 40
	GeometryMinorRadius   = 40
	GeometryHeight        = 10
	GeometryOffset		= X:0 Y:0 Z:0
	GeometryIsSmall       = No

	AdditionalGeometry		= CYLINDER
	GeometryName			= Geom_V1
	GeometryMajorRadius		= 45
	GeometryMinorRadius		= 45
	GeometryHeight			= 20
	GeometryOffset			= X:-10 Y:-5 Z:60

	AdditionalGeometry		= CYLINDER
	GeometryName			= Geom_V2
	GeometryMajorRadius		= 17
	GeometryHeight			= 100
	GeometryOffset			= X:-10 Y:-7 Z:0

	Shadow                = SHADOW_VOLUME
	BuildCompletion     	= PLACED_BY_PLAYER

  	GeometryContactPoint	= X:-33		Y:10		Z:0		Repair
	GeometryContactPoint	= X:30		Y:10		Z:0		Repair
End


ChildObject ElvenNiphredilMallornTreeFoundation ElvenNiphredilMallornTree
  Draw = W3DScriptedModelDraw ModuleTag_Draw
		OkToChangeModelColor  = Yes
		StaticModelLODMode = yes
		UseStandardModelNames = Yes


		DefaultModelConditionState
			Model = ebNmallorn1_nip  ;EBMalTree
			; ParticleSysBone     =  FireFlyBone FireFlies02 FollowBone:Yes
		    ;WeaponLaunchBone = PRIMARY ARCHER01
		End

		ModelConditionState = USER_28
			Model = ebNmallorn1_nip  ;EBMalTree
			ParticleSysBone  = None TollKeepersAura Followbone:No
			ParticleSysBone  = None TollKeepersGold Followbone:No
			ParticleSysBone  = None TollKeepersGreen Followbone:No
		End

		ModelConditionState = USER_29
			Model =ebNmallorn1_nip  ;EBMalTree
			ParticleSysBone  = None CursedTreasureAura Followbone:No
			ParticleSysBone  = None CursedTreasureGold Followbone:No
			ParticleSysBone  = None CursedTreasureGreen Followbone:No
		End

	ModelConditionState				= BUILD_PLACEMENT_CURSOR
		Shadow						= SHADOW_ALPHA_DECAL
		ShadowTexture				= decal_hero_good
		ShadowSizeX					= 385 ;ELVEN_STATUE_AOE_RADIUS_DECAL
		ShadowSizeY					= 385 ;ELVEN_STATUE_AOE_RADIUS_DECAL
		ShadowOverrideLODVisibility = Yes
	End
	;//	Animation state for build placement cursor
	AnimationState = BUILD_PLACEMENT_CURSOR
		BeginScript
			CurDrawableHideSubObject("N_Window")
			CurDrawableHideSubObject("N_Glow")
   			CurDrawableHideSubObject("V1")
   			CurDrawableHideSubObject("V1a")
			CurDrawableHideSubObject("V2")
			CurDrawableHideSubObject("V2a")
		EndScript
	End
	;//	Animation state for phantom structure
	AnimationState = PHANTOM_STRUCTURE
		BeginScript
			CurDrawableHideSubObject("N_Window")
			CurDrawableHideSubObject("N_Glow")
   			CurDrawableHideSubObject("V1")
   			CurDrawableHideSubObject("V1a")
			CurDrawableHideSubObject("V2")
			CurDrawableHideSubObject("V2a")
		EndScript
	End
    IdleAnimationState
		ParticleSysBone = NONE LorienFallingLeaves
		ParticleSysBone = NONE FireFliesLorien	
	End
    ;------------ Build Up States -------
    ModelConditionState = SNOW AWAITING_CONSTRUCTION
		Model	= ebNmallorn0_bld  ;EBMalTree_ASKN
		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
		Texture = ebNmallornA.tga ebNmallornA_snow.tga
	End
    ModelConditionState   = AWAITING_CONSTRUCTION
      Model               = ebNmallorn0_bldEBMalTree_ASKN
;		ParticleSysBone	  = NONE BuildingDoughnutCloud
    End
    AnimationState        = AWAITING_CONSTRUCTION
      Animation           =  ebNmallorn0_bld  ;EBMalTree_A
        AnimationName     =  ebNmallorn0_bld.ebNmallorn0_bld  ;EBMalTree_ASKL.EBMalTree_ABLD
        AnimationMode     = MANUAL
        AnimationBlendTime = 0
      End
	  Flags				  = START_FRAME_FIRST
    End
	ModelConditionState = SNOW ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
		Model	= ebNmallorn0_bld   ;EBMalTree_ASKN
		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
		Texture = ebNmallornA.tga ebNmallornA_snow.tga
	End
    ModelConditionState   = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
      Model               = ebNmallorn0_bld  ;EBMalTree_ASKN
		ParticleSysBone   = CONSTDUSTBONE01 BuildingContructDust FollowBone:Yes
		ParticleSysBone = NONE ExpLeavesLorien
    End;
    AnimationState        = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
		Animation           = ebNmallorn0_bld  ;EBMalTree_A
			AnimationName     = ebNmallorn0_bld.ebNmallorn0_bld  ;EBMalTree_ASKL.EBMalTree_ABLD
			AnimationMode     = MANUAL
			AnimationBlendTime = 0
		End
		Flags				  = START_FRAME_FIRST
		StateName				= BeingConstructed
		BeginScript
			CurDrawablePlaySound("GondorBarracksBeginConstruction")
			CurDrawablePlaySound("LothlorienConstructionSong")
			CurDrawablePlaySound("LothlorienConstruction")
		EndScript
    End
      ;--damaged building
		ModelConditionState     = DAMAGED
			Model               = ebNmal1_nip_d1  ;EBMalTree_D1
		End
		AnimationState =	DAMAGED
			EnteringStateFX	= FX_StatueDamaged
			ParticleSysBone = NONE LorienBaseLeaves
			ParticleSysBone = NONE Maltreedust
		End
		ModelConditionState     = REALLYDAMAGED
			Model               = ebNmal1_nip_d2  ;EBMalTree_D2
		End
    	AnimationState =	REALLYDAMAGED
    		Animation	= RubbleAnimation
				AnimationName		=	ebNmal1_nip_d2.ebNmal1_nip_d2  ;EBMalTree_D2SK.EBMalTree_D2AN
				AnimationMode		=	ONCE
	  		End
			EnteringStateFX	= FX_StatueDamaged
		End
		ModelConditionState  = RUBBLE
			Model         =  ebNmal1_nip_d2    ;EBMalTree_D3
			ParticleSysBone SmokeLarge01 SmokeBuildingLarge
		End
		AnimationState = RUBBLE
			Animation	= RubbleAnimation
				AnimationName		=	ebNmal1_nip_d2.ebNmal1_nip_d2   ;EBMalTree_D3SK.EBMalTree_D3AN
				AnimationMode		=	ONCE
	  		End
	  		EnteringStateFX	= FX_StructureMediumCollapse
		End
		ModelConditionState  = POST_RUBBLE
			Model         = None
			ParticleSysBone NONE SmokeBuildingMediumRubble
		End
		ModelConditionState  = POST_COLLAPSE
			Model         = None
			ParticleSysBone NONE SmokeBuildingMediumRubble
		End

	    ModelConditionState = SNOW
			Model = ebNmallorn1_nip  ;EBMalTree
		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
		Texture = ebNmallornA.tga ebNmallornA_snow.tga
        End
  End

 	//Mallorn Roots
	Draw = W3DScriptedModelDraw ModuleTag_DrawMallornRoots
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		//Normal
		ModelConditionState = UPGRADE_NUMENOR_STONEWORK
			Model           = ebNmallorn2_roo  ;ebmalroots_skn
		End
	End
 	//Star-lit Lanterns
	Draw = W3DScriptedModelDraw ModuleTag_DrawStarlitLanterns
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD
		ExtraPublicBone = B_LANTERN01
		ExtraPublicBone = B_LANTERN02
		ExtraPublicBone = B_LANTERN03
		ExtraPublicBone = B_LANTERN04
		ExtraPublicBone = B_LANTERN05


		DefaultModelConditionState
			Model           = None
		End

		//Normal
		ModelConditionState = USER_3
			Model           = ebNmallorn2_lan
		End
	End
 	//Silvan Levy
	Draw = W3DScriptedModelDraw ModuleTag_DrawSilvanLevy
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		//Normal
		ModelConditionState = USER_6
			Model           = ebNmallorn2_sil
		End
	End
	Draw = W3DScriptedModelDraw ModuleTag_DrawNiphredilBloom2
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		//Normal
		ModelConditionState = USER_8
			Model           = ebNmall1_nip3
		End
		ModelConditionState     = USER_8 DAMAGED
			Model               = ebNmall1_nip3  ;EBMalTree_D1
			Texture =			ebNmallornA.tga ebNmallornA_D.tga
		End

	End
 	//Niphredil Bloom rank 3
	Draw = W3DScriptedModelDraw ModuleTag_DrawNiphredilBloom3
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD

		DefaultModelConditionState
			Model           = None
		End

		//Normal
		ModelConditionState = USER_9
			Model           = ebNmall1_nip4
		End

		ModelConditionState = USER_9 DAMAGED
			Model           = ebNmall1_nip4
			Texture =			ebNgarrison_d.tga ebNgarrison_d.tga
		End
	End
	Draw = W3DScriptedModelDraw ModuleTag_DrawArrowBones
		OkToChangeModelColor	= Yes
		StaticModelLODMode		= Yes ;// Will append M or L to the skin name depending on GameLOD
		ExtraPublicBone = MALARROW01
		ExtraPublicBone = MALARROW02
		ExtraPublicBone = MALARROW03
		ExtraPublicBone = MALARROW04

		DefaultModelConditionState
			Model           = ebNarrows_skn
			WeaponLaunchBone = PRIMARY MALARROW
		End
	End	
  ; Draw module just for the hero FX.
	Draw = W3DScriptedModelDraw TheHealEffect
	    ModelConditionState  = NONE
			Model = None
		End
	    ModelConditionState  = ACTIVELY_BEING_CONSTRUCTED
			Model = None
		End
	End
  Draw = W3DFloorDraw ModuleTag_DrawFloor
		StaticModelLODMode = Yes		; THIS NEEDS TO BE COMMENTED OUT WHEN ENGINEERING ENABLES LOD'S IN THE FLOOR DRAW
     ModelName = ebNmallorn0_bib  ;EBMalTree_Bib
	WeatherTexture		= SNOWY ebNmallorn_bib_snow.tga ;eblothfort_bib_snow
  End
	Draw = W3DScriptedModelDraw Draw_BonusEffects
	    DefaultModelConditionState
	      Model = None
	    End
	    AnimationState = ACTIVELY_BEING_CONSTRUCTED
	    End
		AnimationState = UPGRADE_ECONOMY_BONUS
			ParticleSysBone	= None FueltheFiresEmbers
		End
		AnimationState = USER_5 ;;,;; Added for 2.02e (T.C.) - Grand Harvest particle system
			ParticleSysBone	= None MirrorofGaladrielMallornSparkle
		End
		AnimationState = USER_5 UPGRADE_ECONOMY_BONUS ;;,;; Added for 2.02e (T.C.)
			ParticleSysBone	= None FueltheFiresEmbers
		End
		AnimationState = USER_4
			ParticleSysBone	= None StoneWorkerFX ; WellHealFX
		End
		AnimationState = USER_4 UPGRADE_ECONOMY_BONUS
			ParticleSysBone	= None FueltheFiresEmbers
		End
		AnimationState = USER_4 USER_5
			ParticleSysBone	= None FueltheFiresEmbers
		End
		AnimationState = USER_4 USER_5 UPGRADE_ECONOMY_BONUS
			ParticleSysBone	= None FueltheFiresEmbers
		End
	End
  PlacementViewAngle  = 0
	Behavior = CastleMemberBehavior ModuleTag_CMB
	End
	VoiceFullyCreated		= EVA:MallornNiphredilBloom
	RemoveModule ModuleTag_MoneyProduction
	RemoveModule ModuleTag_MoneyProductionClient
	Behavior = AutoDepositUpdate AutoDepositModuleTag
		DepositTiming       = FOUNDATION_FARM_MONEY_TIME 	   ; in milliseconds
		DepositAmount       = FOUNDATION_FARM_MONEY_AMOUNT   ; cash amount to deposit every DepositTiming
		InitialCaptureBonus = 0  ; no initial bonus
	End
End

; ChildObject ElvenNiphredilMallornTree_ForAI ElvenNiphredilMallornTree
; 	RemoveModule ModuleTag_MoneyProduction
; 	CommandPointBonus	= 75
; ;	BuildCost = 300 ; 150
; 	Behavior = TerrainResourceBehavior ModuleTag_NewMoney
; 		Radius		= 150; ELVEN_MALLORN_TREE_MONEY_RANGE	; How far we try to claim ground
; 		MaxIncome	= ELVEN_MALLORN_TREE_MONEY_AMOUNT	; If we were to get all we wanted, how much we would earn.  Linear slope to 0 at 0% claim
; 		IncomeInterval	= ELVEN_MALLORN_TREE_MONEY_TIME		; How often (in msec) we give that much money
; 	End
; 	; Behavior = ObjectCreationUpgrade MakeTheArcher
; 	; 	TriggeredBy		= Upgrade_StructureLevel2
; 	; 	Delay			= 32.0
; 	; 	DestroyWhenSold = Yes
; 	; 	ThingToSpawn	= ElvenLorienArcher_Slaved
; 	; 	Offset			= X:-25.8 Y:-4.9 Z:37.2
; 	; 	FadeInTime		= 5000
; 	; End
; 	#include "..\..\..\Includes\AIResourceStructureFunctions.inc"
; End

ChildObject ElvenMallornTree_ForAI ElvenNiphredilMallornTree
Draw = W3DScriptedModelDraw ModuleTag_Draw
		OkToChangeModelColor  = Yes
		StaticModelLODMode = yes
		UseStandardModelNames = Yes

		ExtraPublicBone	= ARCHER01

		DefaultModelConditionState
			Model = ebNmallorn0_skn  ;EBMalTree
			; ParticleSysBone     =  FireFlyBone FireFlies02 FollowBone:Yes
		    ;WeaponLaunchBone = PRIMARY ARCHER01
		End

		ModelConditionState = RIDER7
			Model = ebNmallorn1_nip  ;EBMalTree
			; ParticleSysBone     =  FireFlyBone FireFlies02 FollowBone:Yes
		    ;WeaponLaunchBone = PRIMARY ARCHER01
		End

		ModelConditionState = USER_28 RIDER7
			Model = ebNmallorn1_skn  ;EBMalTree
			WeaponLaunchBone = PRIMARY ARROW
			ParticleSysBone  = None TollKeepersAura Followbone:No
			ParticleSysBone  = None TollKeepersGold Followbone:No
			ParticleSysBone  = None TollKeepersGreen Followbone:No
		End

		ModelConditionState = USER_28
			Model = ebNmallorn0_skn  ;EBMalTree
			WeaponLaunchBone = PRIMARY ARROW
			ParticleSysBone  = None TollKeepersAura Followbone:No
			ParticleSysBone  = None TollKeepersGold Followbone:No
			ParticleSysBone  = None TollKeepersGreen Followbone:No
		End

		ModelConditionState = USER_29 RIDER7
			Model = ebNmallorn1_skn  ;EBMalTree
			WeaponLaunchBone = PRIMARY ARROW
			ParticleSysBone  = None CursedTreasureAura Followbone:No
			ParticleSysBone  = None CursedTreasureGold Followbone:No
			ParticleSysBone  = None CursedTreasureGreen Followbone:No
		End

		ModelConditionState = USER_29
			Model = ebNmallorn0_skn  ;EBMalTree
			WeaponLaunchBone = PRIMARY ARROW
			ParticleSysBone  = None CursedTreasureAura Followbone:No
			ParticleSysBone  = None CursedTreasureGold Followbone:No
			ParticleSysBone  = None CursedTreasureGreen Followbone:No
		End

	ModelConditionState				= BUILD_PLACEMENT_CURSOR
		Shadow						= SHADOW_ALPHA_DECAL
		ShadowTexture				= decal_hero_good
		ShadowSizeX					= 385 ;ELVEN_STATUE_AOE_RADIUS_DECAL
		ShadowSizeY					= 385 ;ELVEN_STATUE_AOE_RADIUS_DECAL
		ShadowOverrideLODVisibility = Yes
	End
	;//	Animation state for build placement cursor
	AnimationState = BUILD_PLACEMENT_CURSOR
		BeginScript
			CurDrawableHideSubObject("N_Window")
			CurDrawableHideSubObject("N_Glow")
   			CurDrawableHideSubObject("V1")
   			CurDrawableHideSubObject("V1a")
			CurDrawableHideSubObject("V2")
			CurDrawableHideSubObject("V2a")
		EndScript
	End
	;//	Animation state for phantom structure
	AnimationState = PHANTOM_STRUCTURE
		BeginScript
			CurDrawableHideSubObject("N_Window")
			CurDrawableHideSubObject("N_Glow")
   			CurDrawableHideSubObject("V1")
   			CurDrawableHideSubObject("V1a")
			CurDrawableHideSubObject("V2")
			CurDrawableHideSubObject("V2a")
		EndScript
	End
    IdleAnimationState
		ParticleSysBone = NONE LorienFallingLeaves
		ParticleSysBone = NONE FireFliesLorien
	End
    ;------------ Build Up States -------
    ModelConditionState = SNOW AWAITING_CONSTRUCTION
		Model	= ebNmallorn0_bld  ;EBMalTree_ASKN
		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
		Texture = ebNmallornA.tga ebNmallornA_snow.tga
	End
    ModelConditionState   = AWAITING_CONSTRUCTION
      Model               = ebNmallorn0_bldEBMalTree_ASKN
;		ParticleSysBone	  = NONE BuildingDoughnutCloud
    End
    AnimationState        = AWAITING_CONSTRUCTION
      Animation           =  ebNmallorn0_bld  ;EBMalTree_A
        AnimationName     =  ebNmallorn0_bld.ebNmallorn0_bld  ;EBMalTree_ASKL.EBMalTree_ABLD
        AnimationMode     = MANUAL
        AnimationBlendTime = 0
      End
	  Flags				  = START_FRAME_FIRST
    End
	ModelConditionState = SNOW ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
		Model	= ebNmallorn0_bld   ;EBMalTree_ASKN
		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
		Texture = ebNmallornA.tga ebNmallornA_snow.tga
		ParticleSysBone   = CONSTDUSTBONE01 BuildingContructDust FollowBone:Yes
		ParticleSysBone = NONE ExpLeavesLorien
	End
    ModelConditionState   = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
      Model               = ebNmallorn0_bld  ;EBMalTree_ASKN
		ParticleSysBone   = CONSTDUSTBONE01 BuildingContructDust FollowBone:Yes
		ParticleSysBone = NONE ExpLeavesLorien
    End;
    AnimationState        = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
		Animation           = ebNmallorn0_bld  ;EBMalTree_A
			AnimationName     = ebNmallorn0_bld.ebNmallorn0_bld  ;EBMalTree_ASKL.EBMalTree_ABLD
			AnimationMode     = MANUAL
			AnimationBlendTime = 0
		End
		Flags				  = START_FRAME_FIRST
		StateName				= BeingConstructed
		BeginScript
			CurDrawablePlaySound("GondorBarracksBeginConstruction")
			CurDrawablePlaySound("LothlorienConstructionSong")
			CurDrawablePlaySound("LothlorienConstruction")
		EndScript
    End
      ;--damaged building
	  ModelConditionState     = DAMAGED RIDER7
			Model               = ebNmal1_nip_d1  ;EBMalTree_D1
		End

		ModelConditionState     = DAMAGED
			Model               = ebNmallorn0_d1  ;EBMalTree_D1
		End

		AnimationState =	DAMAGED
			EnteringStateFX	= FX_StatueDamaged
			ParticleSysBone = NONE LorienBaseLeaves
			ParticleSysBone = NONE Maltreedust
		End

		ModelConditionState     = REALLYDAMAGED RIDER7
			Model               = ebNmal1_nip_d2   ;EBMalTree_D2
		End
		ModelConditionState     = REALLYDAMAGED
			Model               = ebNmallorn0_d2  ;EBMalTree_D2
		End

		AnimationState =	REALLYDAMAGED RIDER7
    		Animation	= RubbleAnimation
				AnimationName		=	ebNmal1_nip_d2.ebNmal1_nip_d2  ;EBMalTree_D2SK.EBMalTree_D2AN
				AnimationMode		=	ONCE
	  		End
			EnteringStateFX	= FX_StatueDamaged
		End

    	AnimationState =	REALLYDAMAGED
    		Animation	= RubbleAnimation
				AnimationName		=	ebNmallorn0_d2.ebNmallorn0_d2  ;EBMalTree_D2SK.EBMalTree_D2AN
				AnimationMode		=	ONCE
	  		End
			EnteringStateFX	= FX_StatueDamaged
		End

		ModelConditionState  = RUBBLE RIDER7
			Model         =  ebNmal1_nip_d2    ;EBMalTree_D3
			ParticleSysBone SmokeLarge01 SmokeBuildingLarge
		End

		ModelConditionState  = RUBBLE
			Model         =  ebNmallorn0_d2    ;EBMalTree_D3
			ParticleSysBone SmokeLarge01 SmokeBuildingLarge
		End

		AnimationState = RUBBLE RIDER7
			Animation	= RubbleAnimation
				AnimationName		=	ebNmal1_nip_d2.ebNmal1_nip_d2   ;EBMalTree_D3SK.EBMalTree_D3AN
				AnimationMode		=	ONCE
	  		End
	  		EnteringStateFX	= FX_StructureMediumCollapse
		End

		AnimationState = RUBBLE
			Animation	= RubbleAnimation
				AnimationName		=	ebNmallorn0_d2.ebNmallorn0_d2   ;EBMalTree_D3SK.EBMalTree_D3AN
				AnimationMode		=	ONCE
	  		End
	  		EnteringStateFX	= FX_StructureMediumCollapse
		End
		
		ModelConditionState  = POST_RUBBLE
			Model         = None
			ParticleSysBone NONE SmokeBuildingMediumRubble
		End
		ModelConditionState  = POST_COLLAPSE
			Model         = None
			ParticleSysBone NONE SmokeBuildingMediumRubble
		End

		ModelConditionState = SNOW RIDER7
			Model = ebNmallorn1_nip  ;EBMalTree
		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
		Texture = ebNmallornA.tga ebNmallornA_snow.tga
        End

	    ModelConditionState = SNOW
			Model = ebNmallorn0_skn  ;EBMalTree
		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
		Texture = ebNmallornA.tga ebNmallornA_snow.tga
        End
  End
; Draw = W3DScriptedModelDraw ModuleTag_Draw
; 		OkToChangeModelColor  = Yes
; 		StaticModelLODMode = yes
; 		UseStandardModelNames = Yes


; 		DefaultModelConditionState
; 			Model = ebNmallorn1_nip  ;EBMalTree
; 			; ParticleSysBone     =  FireFlyBone FireFlies02 FollowBone:Yes
; 		    ;WeaponLaunchBone = PRIMARY ARCHER01
; 		End

; 		ModelConditionState = USER_28
; 			Model = ebNmallorn1_nip  ;EBMalTree
; 			ParticleSysBone  = None TollKeepersAura Followbone:No
; 			ParticleSysBone  = None TollKeepersGold Followbone:No
; 			ParticleSysBone  = None TollKeepersGreen Followbone:No
; 		End

; 		ModelConditionState = USER_29
; 			Model =ebNmallorn1_nip  ;EBMalTree
; 			ParticleSysBone  = None CursedTreasureAura Followbone:No
; 			ParticleSysBone  = None CursedTreasureGold Followbone:No
; 			ParticleSysBone  = None CursedTreasureGreen Followbone:No
; 		End

; 	ModelConditionState				= BUILD_PLACEMENT_CURSOR
; 		Shadow						= SHADOW_ALPHA_DECAL
; 		ShadowTexture				= decal_hero_good
; 		ShadowSizeX					= 385 ;ELVEN_STATUE_AOE_RADIUS_DECAL
; 		ShadowSizeY					= 385 ;ELVEN_STATUE_AOE_RADIUS_DECAL
; 		ShadowOverrideLODVisibility = Yes
; 	End
; 	;//	Animation state for build placement cursor
; 	AnimationState = BUILD_PLACEMENT_CURSOR
; 		BeginScript
; 			CurDrawableHideSubObject("N_Window")
; 			CurDrawableHideSubObject("N_Glow")
;    			CurDrawableHideSubObject("V1")
;    			CurDrawableHideSubObject("V1a")
; 			CurDrawableHideSubObject("V2")
; 			CurDrawableHideSubObject("V2a")
; 		EndScript
; 	End
; 	;//	Animation state for phantom structure
; 	AnimationState = PHANTOM_STRUCTURE
; 		BeginScript
; 			CurDrawableHideSubObject("N_Window")
; 			CurDrawableHideSubObject("N_Glow")
;    			CurDrawableHideSubObject("V1")
;    			CurDrawableHideSubObject("V1a")
; 			CurDrawableHideSubObject("V2")
; 			CurDrawableHideSubObject("V2a")
; 		EndScript
; 	End
;     IdleAnimationState
; 		ParticleSysBone = NONE LorienFallingLeaves
; 		ParticleSysBone = NONE FireFliesLorien	
; 	End
;     ;------------ Build Up States -------
;    ModelConditionState = SNOW AWAITING_CONSTRUCTION
; 		Model	= ebNmallorn0_bld  ;EBMalTree_ASKN
; 		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
; 		Texture = ebNmallornA.tga ebNmallornA_snow.tga
; 	End
;    ModelConditionState   = AWAITING_CONSTRUCTION
;      Model               = ebNmallorn0_bldEBMalTree_ASKN
; ;		ParticleSysBone	  = NONE BuildingDoughnutCloud
;    End

;    AnimationState        = AWAITING_CONSTRUCTION
;       Animation           =  ebNmallorn0_bld  ;EBMalTree_A
;        AnimationName     =  ebNmallorn0_bld.ebNmallorn0_bld  ;EBMalTree_ASKL.EBMalTree_ABLD
;        AnimationMode     = MANUAL
;        AnimationBlendTime = 0
;      End
; 	  Flags				  = START_FRAME_FIRST
;    End

; 	ModelConditionState = SNOW ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
; 		Model	= ebNmallorn0_bld   ;EBMalTree_ASKN
; 		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
; 		Texture = ebNmallornA.tga ebNmallornA_snow.tga
; 	End

;    ModelConditionState   = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
;      Model               = ebNmallorn0_bld  ;EBMalTree_ASKN
; 		ParticleSysBone   = CONSTDUSTBONE01 BuildingContructDust FollowBone:Yes
; 		ParticleSysBone = NONE ExpLeavesLorien
;    End;

;    AnimationState        = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
; 		Animation           = ebNmallorn0_bld  ;EBMalTree_A
; 			AnimationName     = ebNmallorn0_bld.ebNmallorn0_bld  ;EBMalTree_ASKL.EBMalTree_ABLD
; 			AnimationMode     = MANUAL
; 			AnimationBlendTime = 0
; 		End
; ;		Flags				  = START_FRAME_FIRST
; 		StateName				= BeingConstructed
; 		BeginScript
; 			CurDrawablePlaySound("GondorBarracksBeginConstruction")
; 		EndScript
;    End
;       ;--damaged building
; 		ModelConditionState     = DAMAGED
; 			Model               = ebNmal1_nip_d1  ;EBMalTree_D1
; 		End
; 		AnimationState =	DAMAGED
; 			EnteringStateFX	= FX_StatueDamaged
; 			ParticleSysBone = NONE LorienBaseLeaves
; 			ParticleSysBone = NONE Maltreedust
; 		End
; 		ModelConditionState     = REALLYDAMAGED
; 			Model               = ebNmal1_nip_d2  ;EBMalTree_D2
; 		End
;     	AnimationState =	REALLYDAMAGED
;     		Animation	= RubbleAnimation
; 				AnimationName		=	ebNmal1_nip_d2.ebNmal1_nip_d2  ;EBMalTree_D2SK.EBMalTree_D2AN
; 				AnimationMode		=	ONCE
; 	  		End
; 			EnteringStateFX	= FX_StatueDamaged
; 		End
; 		ModelConditionState  = RUBBLE
; 			Model         =  ebNmal1_nip_d2    ;EBMalTree_D3
; 			ParticleSysBone SmokeLarge01 SmokeBuildingLarge
; 		End
; 		AnimationState = RUBBLE
; 			Animation	= RubbleAnimation
; 				AnimationName		=	ebNmal1_nip_d2.ebNmal1_nip_d2   ;EBMalTree_D3SK.EBMalTree_D3AN
; 				AnimationMode		=	ONCE
; 	  		End
; 	  		EnteringStateFX	= FX_StructureMediumCollapse
; 		End
; 		ModelConditionState  = POST_RUBBLE
; 			Model         = None
; 			ParticleSysBone NONE SmokeBuildingMediumRubble
; 		End
; 		ModelConditionState  = POST_COLLAPSE
; 			Model         = None
; 			ParticleSysBone NONE SmokeBuildingMediumRubble
; 		End

; 	    ModelConditionState = SNOW
; 			Model = ebNmallorn1_nip  ;EBMalTree
; 		Texture = ebNgoldtree.tga ebNgoldtree_snow.tga
; 		Texture = ebNmallornA.tga ebNmallornA_snow.tga
;         End
;   End
	RemoveModule ModuleTag_MoneyProduction
	RemoveModule ModuleTag_SoWeCanUseWeapon

	Behavior = TerrainResourceBehavior ModuleTag_AIMoneyProduction
		Radius		= 150 ;ELVEN_MALLORN_TREE_MONEY_RANGE	; How far we try to claim ground
		MaxIncome	= 15 ; ELVEN_MALLORN_TREE_MONEY_AMOUNT	; If we were to get all we wanted, how much we would earn.  Linear slope to 0 at 0% claim
		IncomeInterval	= ELVEN_MALLORN_TREE_MONEY_TIME		; How often (in msec) we give that much money
	End

	Behavior = GrantUpgradeCreate ModuleTag_AIAutoUnpacker
		UpgradeToGrant = Upgrade_HorseDiscipline
		GiveOnBuildComplete = Yes
	End

	Behavior = ObjectCreationUpgrade ModuleTag_FakeNiphredilUpgrader
		TriggeredBy = Upgrade_HorseDiscipline
		GrantUpgrade = Upgrade_TalanNiphredilBloom
		Delay = 20000
	End

	Behavior = AIUpdateInterface ModuleTag_AILuaFunctions
		AutoAcquireEnemiesWhenIdle	= Yes
		MoodAttackCheckRate			= 250
		AILuaEventsList				= AIMallornTreeFunctions ;MirkwoodShrineFunctions
	End


	Behavior = ModelConditionUpgrade ModuleTag_NiphredilFakeBloomer
		TriggeredBy				= Upgrade_TalanNiphredilBloom
		AddConditionFlags		= RIDER7
	End

	Behavior = AttributeModifierUpgrade ModuleTag_NiphredilUpgradedResourceOutput
		TriggeredBy				= Upgrade_TalanNiphredilBloom
		AttributeModifier		= AILothlorienNiphredilUpgrade
	End

	;//This plays the upgrade FX triggered via LUA since we are hacking our upgrades
	; Behavior = SpecialPowerModule ModuleTag_FXPlayerOne
	; 	SpecialPowerTemplate = SpecialAbilityActivateeDummy
	; 	StartsPaused = No
	; 	TriggerFX = FX_DwarvenFortressUpgrade
	; End
	Behavior = PlayerHealSpecialPower ModuleTag_FXAndHeal
		SpecialPowerTemplate		= SpecialAbilityActivateeDummy
		HealAmount			= 2000
		HealAsPercent			= No
		HealAffects			= NONE +ElvenMallornTree_ForAI SAME_PLAYER
		HealRadius			= 10
	;	HealFX				= FX_AragornAthelas
		TriggerFX			= FX_DwarvenFortressUpgrade
	End
	#include "..\..\..\Includes\AIResourceStructureFunctions.inc
	;//////
	;// Automatic Upgrade that triggers the unpacking
	;//////
	; Behavior = GrantUpgradeCreate ModuleTag_AIAutoUnpacker
	; 	UpgradeToGrant = Upgrade_SwitchToRockThrowing
	; 	GiveOnBuildComplete = Yes
	; End

	; Behavior = DoCommandUpgrade ModuleTag_UnpackNiphredilAI
	; 	TriggeredBy = Upgrade_SwitchToRockThrowing ; Upgrade_ObjectUnderAIControl
	; 	GetUpgradeCommandButtonName = Command_UpgradeMallornNiphredilBloom_AI
	; End
	;-------------------------------------------------
	;--- Unique AI Mallorn
	;-------------------------------------------------
	;RemoveModule ModuleTag_ReplaceWithNiphredil
	; Behavior = ReplaceSelfUpgrade ModuleTag_ReplaceWithNiphredilAI
	; 	TriggeredBy = Upgrade_MallornTreeNiphredilAI; L00BE9600: List of Upgrades //Must have these upgrades
	; 	RequiresAllTriggers = Yes; SUB_L006D3400:Boolean //All "TriggeredBy" Upgrades required! (meaning that if only one is present the module is not active)
	; 	Permanent = Yes; SUB_L006D3400:Boolean //For ever... and ever... and ever, even if the upgrades are lost...
	; 	ReplaceWith = ElvenNiphredilMallornTree_ForAI
	;  ; ;AndThenAddA = ObjectExtra; SUB_L006D34D0:Strings(Object)
	; End
End
